<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.12 (AI Powered)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .gradient-bg {
            background-image: linear-gradient(to right, #667eea, #764ba2);
        }
        .tab-active {
            border-bottom: 3px solid #fff;
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .tab-inactive {
            color: #e0e0e0;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .notification-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .notification-panel.open {
            transform: translateX(0);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.4);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #667eea, #764ba2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #667eea;
        }
        .btn-primary:disabled {
            background-image: none;
            background-color: #a3a3a3;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-2xl font-bold">üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.12 ‚ú®</h1>
                <div class="relative">
                    <button id="notification-bell" class="relative focus:outline-none">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
            <!-- Tabs Navigation -->
            <nav id="tabs-container" class="bg-white/10">
                <div class="container mx-auto px-4 flex space-x-2 overflow-x-auto">
                    <button data-tab="dashboard" class="py-3 px-4 font-semibold whitespace-nowrap tab-active">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    <button data-tab="debtors" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="debts" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="payments" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="notifications" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô & ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 md:p-6">
            <div id="tab-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </main>

    </div>

    <!-- Modals & Overlays -->
    <div id="modal-container"></div>
    <div id="alert-container" class="fixed top-20 right-5 z-50 space-y-2"></div>
    <div id="notification-panel-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let state = {
            debtors: [],
            debts: [],
            payments: [],
            notifications: [],
            settings: {
                notifications: {
                    overdue: true,
                    upcoming: true,
                    daysInAdvance: 7
                },
                googleSheetUrl: ''
            },
            activeTab: 'dashboard',
            syncStatus: 'idle' // idle, syncing, success, error
        };

        // --- UTILITY FUNCTIONS ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        const getDaysDifference = (date1, date2) => {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round((new Date(date1) - new Date(date2)) / oneDay);
        };

        // --- LOCAL STORAGE ---
        const saveData = () => {
            localStorage.setItem('debtManagerDataV12', JSON.stringify(state));
        };

        const loadData = () => {
            const data = localStorage.getItem('debtManagerDataV12');
            if (data) {
                state = JSON.parse(data);
                 // Ensure nested properties exist
                if (!state.settings) {
                    state.settings = {
                        notifications: { overdue: true, upcoming: true, daysInAdvance: 7 },
                        googleSheetUrl: ''
                    };
                }
                 if (!state.syncStatus) {
                    state.syncStatus = 'idle';
                }
            }
        };

        // --- CALCULATION LOGIC ---
        const calculateDebtDetails = (debtId) => {
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt) return { totalInterest: 0, totalPaid: 0, balance: 0, isOverdue: false, daysOverdue: 0 };

            const startDate = new Date(debt.date);
            const today = new Date();
            const monthsDiff = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
            
            const totalInterest = monthsDiff > 0 ? debt.amount * (debt.interestRate / 100) * monthsDiff : 0;
            const totalDebt = debt.amount + totalInterest;
            
            const paymentsForDebt = state.payments.filter(p => p.debtId === debtId);
            const totalPaid = paymentsForDebt.reduce((sum, p) => sum + p.amount, 0);

            const balance = totalDebt - totalPaid;
            const isOverdue = new Date(debt.dueDate) < today && balance > 0;
            const daysOverdue = isOverdue ? getDaysDifference(today, debt.dueDate) : 0;

            return { totalInterest, totalPaid, balance, totalDebt, isOverdue, daysOverdue };
        };

        const getDebtorSummary = (debtorId) => {
            const debtorDebts = state.debts.filter(d => d.debtorId === debtorId);
            let totalBalance = 0;
            debtorDebts.forEach(debt => {
                const { balance } = calculateDebtDetails(debt.id);
                totalBalance += balance;
            });
            return { totalBalance };
        };

        // --- GEMINI API INTEGRATION ---
        const callGeminiAPI = async (prompt) => {
            const apiKey = ""; // This will be provided by the execution environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text;
                } else {
                    console.error("API Response:", result);
                    throw new Error("No text found in API response.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI', 'error');
                return null;
            }
        };

        // --- UI RENDERING ---
        const render = () => {
            const tab = state.activeTab;
            const contentEl = document.getElementById('tab-content');
            
            // Update tabs UI
            document.querySelectorAll('#tabs-container button').forEach(button => {
                if (button.dataset.tab === tab) {
                    button.classList.remove('tab-inactive');
                    button.classList.add('tab-active');
                } else {
                    button.classList.remove('tab-active');
                    button.classList.add('tab-inactive');
                }
            });

            // Render content
            if (tab === 'dashboard') contentEl.innerHTML = renderDashboard();
            if (tab === 'debtors') contentEl.innerHTML = renderDebtors();
            if (tab === 'debts') contentEl.innerHTML = renderDebts();
            if (tab === 'payments') contentEl.innerHTML = renderPayments();
            if (tab === 'notifications') contentEl.innerHTML = renderNotificationsAndSettings();
            
            attachEventListeners();
            updateNotificationBell();
        };

        const renderDashboard = () => {
            let totalDebtors = state.debtors.length;
            let totalPrincipal = state.debts.reduce((sum, d) => sum + d.amount, 0);
            let totalPaid = state.payments.reduce((sum, p) => sum + p.amount, 0);
            let totalInterest = 0;
            let overdueDebtsCount = 0;
            let upcomingDebts = [];
            
            state.debts.forEach(debt => {
                const details = calculateDebtDetails(debt.id);
                totalInterest += details.totalInterest;
                if(details.isOverdue) overdueDebtsCount++;

                const daysUntilDue = getDaysDifference(debt.dueDate, new Date());
                if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                    upcomingDebts.push({ ...debt, daysUntilDue, balance: details.balance });
                }
            });

            const totalDebtValue = totalPrincipal + totalInterest;
            const totalBalance = totalDebtValue - totalPaid;
            
            const paymentProgress = totalDebtValue > 0 ? (totalPaid / totalDebtValue) * 100 : 0;

            const overdueAlert = overdueDebtsCount > 0 ? `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 animate-pulse">
                    <p class="font-bold">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô!</p>
                    <p>‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${overdueDebtsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>` : '';
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="card bg-white p-4 rounded-lg shadow">
                        <h3 class="text-gray-500">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-2xl font-bold">${totalDebtors} ‡∏Ñ‡∏ô</p>
                    </div>
                    <div class="card bg-white p-4 rounded-lg shadow">
                        <h3 class="text-gray-500">üí∞ ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô)</h3>
                        <p class="text-2xl font-bold">${formatCurrency(totalPrincipal)}</p>
                    </div>
                    <div class="card bg-white p-4 rounded-lg shadow">
                        <h3 class="text-gray-500">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°</h3>
                        <p class="text-2xl font-bold">${formatCurrency(totalInterest)}</p>
                    </div>
                    <div class="card bg-white p-4 rounded-lg shadow">
                        <h3 class="text-gray-500 text-green-600">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</h3>
                        <p class="text-2xl font-bold text-green-600">${formatCurrency(totalPaid)}</p>
                    </div>
                    <div class="card bg-white p-4 rounded-lg shadow">
                        <h3 class="text-gray-500 text-red-600">‚ùó ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h3>
                        <p class="text-2xl font-bold text-red-600">${formatCurrency(totalBalance)}</p>
                    </div>
                </div>

                ${overdueAlert}

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</th>
                                        <th class="px-4 py-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                        <th class="px-4 py-2">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${upcomingDebts.length > 0 ? upcomingDebts.sort((a,b) => a.daysUntilDue - b.daysUntilDue).map(debt => `
                                        <tr class="bg-white border-b">
                                            <td class="px-4 py-2 font-medium">${state.debtors.find(d => d.id === debt.debtorId)?.name || 'N/A'}</td>
                                            <td class="px-4 py-2">${formatCurrency(debt.balance)}</td>
                                            <td class="px-4 py-2"><span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${debt.daysUntilDue} ‡∏ß‡∏±‡∏ô</span></td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="3" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-gray-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${formatCurrency(totalPaid)} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${formatCurrency(totalDebtValue)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 my-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full" style="width: ${paymentProgress.toFixed(2)}%"></div>
                        </div>
                        <p class="text-right font-bold">${paymentProgress.toFixed(2)}%</p>
                    </div>
                    <div class="lg:col-span-3 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">‚ú® AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-sm text-gray-500 mb-4">‡πÉ‡∏´‡πâ Gemini ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</p>
                        <button id="analyze-debt-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold w-full flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏¢
                        </button>
                        <div id="ai-analysis-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 text-sm whitespace-pre-wrap hidden"></div>
                    </div>
                </div>
            `;
        };

        const renderDebtors = () => {
            return `
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h2>
                    <div class="space-x-2">
                        <button id="import-debtors-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
                        <button id="export-debtors-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3>
                    <form id="debtor-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="debtor-id">
                        <div>
                            <label for="debtor-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*</label>
                            <input type="text" id="debtor-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 form-input">
                        </div>
                        <div>
                            <label for="debtor-phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                            <input type="tel" id="debtor-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div>
                            <label for="debtor-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="debtor-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                         <div>
                            <label for="debtor-id-card" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                            <input type="text" id="debtor-id-card" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div class="md:col-span-2">
                            <label for="debtor-address" class="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                            <textarea id="debtor-address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right space-x-2">
                             <button type="reset" id="cancel-edit-debtor" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
                <div id="debtors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.debtors.map(debtor => `
                        <div class="card bg-white p-5 rounded-lg shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-xl font-bold">${debtor.name}</h4>
                                    <p class="text-sm text-gray-500">${debtor.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'}</p>
                                    <p class="text-sm text-gray-500">${debtor.email || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•'}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="edit-debtor-btn text-blue-500 hover:text-blue-700" data-id="${debtor.id}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                                    <button class="delete-debtor-btn text-red-500 hover:text-red-700" data-id="${debtor.id}" title="‡∏•‡∏ö">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="mt-4 border-t pt-4">
                                <p class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-2xl font-bold text-red-600">${formatCurrency(getDebtorSummary(debtor.id).totalBalance)}</p>
                            </div>
                        </div>
                    `).join('')}
                    ${state.debtors.length === 0 ? '<p class="col-span-full text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ, ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>' : ''}
                </div>
                <input type="file" id="debtors-file-input" class="hidden" accept=".xlsx">
            `;
        };

        const renderDebts = () => {
             return `
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold">üí≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ</h2>
                    <div class="space-x-2">
                         <button id="import-debts-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
                        <button id="export-debts-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ</h3>
                    <form id="debt-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="hidden" id="debt-id">
                        <div>
                            <label for="debt-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label>
                            <select id="debt-debtor-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>
                                ${state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="debt-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡πâ‡∏ô)*</label>
                            <input type="number" id="debt-amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input" step="any">
                        </div>
                         <div>
                            <label for="debt-interest-rate" class="block text-sm font-medium text-gray-700">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (% ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)*</label>
                            <input type="number" id="debt-interest-rate" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div>
                            <label for="debt-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ*</label>
                            <input type="date" id="debt-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input" value="${new Date().toISOString().slice(0,10)}">
                        </div>
                        <div>
                            <label for="debt-due-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î*</label>
                            <input type="date" id="debt-due-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div>
                             <label for="debt-type" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ</label>
                             <select id="debt-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                                <option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
                                <option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                                <option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
                                <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="debt-description" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                            <textarea id="debt-description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 text-right space-x-2">
                             <button type="reset" id="cancel-edit-debt" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
                 <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600 uppercase">
                            <tr>
                                <th class="p-3 text-left">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</th>
                                <th class="p-3 text-left">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                <th class="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                <th class="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="debts-list">
                            ${state.debts.map(debt => {
                                const debtor = state.debtors.find(d => d.id === debt.debtorId);
                                const { balance, isOverdue, daysOverdue } = calculateDebtDetails(debt.id);
                                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3 font-semibold">${debtor?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ'}</td>
                                    <td class="p-3">
                                        <div class="font-bold text-lg">${formatCurrency(balance)}</div>
                                        <div class="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô: ${formatCurrency(debt.amount)}</div>
                                    </td>
                                    <td class="p-3">${formatDate(debt.dueDate)}</td>
                                    <td class="p-3">
                                        ${isOverdue ? `<span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded-full text-xs">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${daysOverdue} ‡∏ß‡∏±‡∏ô</span>` : `<span class="bg-green-100 text-green-800 font-bold px-2 py-1 rounded-full text-xs">‡∏õ‡∏Å‡∏ï‡∏¥</span>`}
                                    </td>
                                    <td class="p-3 text-center space-x-1">
                                         <button class="generate-reminder-btn text-purple-500 hover:text-purple-700 p-1" title="‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ß‡∏á‡∏´‡∏ô‡∏µ‡πâ" data-id="${debt.id}">‚úâÔ∏è</button>
                                         <button class="edit-debt-btn text-blue-500 hover:text-blue-700 p-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" data-id="${debt.id}">‚úèÔ∏è</button>
                                         <button class="delete-debt-btn text-red-500 hover:text-red-700 p-1" title="‡∏•‡∏ö" data-id="${debt.id}">üóëÔ∏è</button>
                                    </td>
                                </tr>
                                `
                            }).join('')}
                            ${state.debts.length === 0 ? '<tr><td colspan="5" class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
                <input type="file" id="debts-file-input" class="hidden" accept=".xlsx">
            `;
        };
        
        const renderPayments = () => {
             return `
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold">üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h2>
                     <div class="space-x-2">
                         <button id="import-payments-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
                        <button id="export-payments-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3>
                    <form id="payment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                             <label for="payment-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label>
                            <select id="payment-debtor-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>
                                ${state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                             <label for="payment-debt-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ* <span id="debtor-balance-info" class="text-xs text-gray-500"></span></label>
                            <select id="payment-debt-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input" disabled>
                                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô --</option>
                            </select>
                        </div>
                        <div>
                            <label for="payment-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞*</label>
                            <input type="number" id="payment-amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input" step="any">
                        </div>
                        <div>
                            <label for="payment-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞*</label>
                            <input type="date" id="payment-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input" value="${new Date().toISOString().slice(0,10)}">
                        </div>
                        <div class="md:col-span-2">
                             <label for="payment-method" class="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                             <select id="payment-method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                                <option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                                <option>‡πÄ‡∏ä‡πá‡∏Ñ</option>
                                <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="payment-note" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea id="payment-note" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></textarea>
                        </div>
                        <div class="md:col-span-2 text-right">
                            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
                        </div>
                    </form>
                </div>
                 <h3 class="text-xl font-bold mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                <div class="relative pl-8 border-l-2 border-gray-200">
                    ${state.payments.sort((a,b) => new Date(b.date) - new Date(a.date)).map(payment => {
                        const debt = state.debts.find(d => d.id === payment.debtId);
                        const debtor = state.debtors.find(d => d.id === debt?.debtorId);
                        return `
                        <div class="mb-6 timeline-item">
                            <h4 class="font-bold text-lg text-green-600">${formatCurrency(payment.amount)}</h4>
                            <p class="font-semibold">${debtor?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
                            <p class="text-sm text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏µ‡πâ: ${debt?.description || `‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô ${formatCurrency(debt?.amount)}`}</p>
                            <p class="text-xs text-gray-500">${formatDate(payment.date)} - ${payment.method}</p>
                            ${payment.note ? `<p class="text-xs italic bg-gray-100 p-2 rounded mt-1">"${payment.note}"</p>` : ''}
                        </div>
                        `
                    }).join('')}
                    ${state.payments.length === 0 ? '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</p>' : ''}
                </div>
                 <input type="file" id="payments-file-input" class="hidden" accept=".xlsx">
            `;
        };

        const renderNotificationsAndSettings = () => {
            const getSyncStatusIndicator = () => {
                switch (state.syncStatus) {
                    case 'syncing':
                        return `<span class="flex items-center text-blue-600"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...</span>`;
                    case 'success':
                        return `<span class="text-green-600">‚úî ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</span>`;
                    case 'error':
                        return `<span class="text-red-600">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</span>`;
                    default:
                        return `<span class="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
                }
            };
            
            return `
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-lg shadow">
                             <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
                             <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold text-lg">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" id="setting-notify-overdue" class="form-checkbox h-5 w-5" ${state.settings.notifications.overdue ? 'checked' : ''}> <span class="ml-2">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span></label>
                                        <label class="flex items-center"><input type="checkbox" id="setting-notify-upcoming" class="form-checkbox h-5 w-5" ${state.settings.notifications.upcoming ? 'checked' : ''}> <span class="ml-2">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span></label>
                                        <div class="flex items-center space-x-2">
                                            <label for="setting-days-advance">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                                            <input type="number" id="setting-days-advance" value="${state.settings.notifications.daysInAdvance}" class="w-20 form-input rounded-md">
                                            <span>‡∏ß‡∏±‡∏ô</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="border-t pt-4">
                                     <h3 class="font-semibold text-lg">üìä Google Sheets Integration</h3>
                                     <p class="text-sm text-gray-500 mb-2">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</p>
                                     <div>
                                        <label for="google-sheet-url" class="block text-sm font-medium text-gray-700">Google Apps Script URL</label>
                                        <input type="url" id="google-sheet-url" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" value="${state.settings.googleSheetUrl || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                                     </div>
                                     <div class="flex items-center space-x-2 mt-3">
                                        <button id="load-from-sheets" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-600 transition">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                        <button id="sync-to-sheets" class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-green-600 transition">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                        <div id="sync-status-indicator">${getSyncStatusIndicator()}</div>
                                     </div>
                                </div>
                                 <div class="text-right mt-4">
                                     <button id="save-settings-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                                 </div>
                             </div>
                        </div>
                    </div>
                    <div>
                         <div class="bg-white p-6 rounded-lg shadow">
                             <div class="flex justify-between items-center mb-4">
                                 <h2 class="text-2xl font-bold">üîî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
                                 <div class="space-x-2">
                                     <button id="read-all-notifications" title="‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="text-gray-500 hover:text-blue-600">‚úîÔ∏è</button>
                                     <button id="delete-all-notifications" title="‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="text-gray-500 hover:text-red-600">üóëÔ∏è</button>
                                 </div>
                             </div>
                              <div id="notifications-list" class="space-y-3 max-h-96 overflow-y-auto">
                                ${state.notifications.length > 0 ? state.notifications.map(n => renderNotificationItem(n, false)).join('') : '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>'}
                              </div>
                         </div>
                    </div>
                 </div>
            `;
        };
        
        const renderNotificationItem = (notification, isPanelItem = true) => {
            const statusColors = {
                overdue: { bg: 'bg-red-50', text: 'text-red-700', icon: 'üö®' },
                upcoming: { bg: 'bg-yellow-50', text: 'text-yellow-700', icon: '‚ö†Ô∏è' },
                payment: { bg: 'bg-green-50', text: 'text-green-700', icon: '‚úÖ' }
            };
            const color = statusColors[notification.type] || { bg: 'bg-gray-50', text: 'text-gray-700', icon: '‚ÑπÔ∏è' };
            const readClass = notification.read ? 'opacity-60' : '';
            const buttonClass = isPanelItem ? 'p-1' : 'p-2';

            return `
                <div class="notification-item flex items-start space-x-3 p-3 rounded-lg ${color.bg} ${readClass}" data-id="${notification.id}">
                    <div class="text-xl pt-1">${color.icon}</div>
                    <div class="flex-grow">
                        <p class="font-semibold ${color.text}">${notification.title}</p>
                        <p class="text-sm text-gray-600">${notification.message}</p>
                        <p class="text-xs text-gray-400">${new Date(notification.createdAt).toLocaleString('th-TH')}</p>
                    </div>
                    <div class="flex-shrink-0">
                       ${!notification.read ? `<button class="mark-notification-read ${buttonClass} hover:bg-white rounded-full" title="Mark as read" data-id="${notification.id}">‚úîÔ∏è</button>` : ''}
                        <button class="delete-notification ${buttonClass} hover:bg-white rounded-full" title="Delete" data-id="${notification.id}">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        };

        const renderNotificationPanel = () => {
            const container = document.getElementById('notification-panel-container');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            container.innerHTML = `
                <div id="notification-panel-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
                <div id="notification-panel" class="notification-panel fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-2xl z-50 flex flex-col">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-lg font-bold">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (${unreadCount})</h3>
                        <button id="close-notification-panel" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                    </div>
                    <div class="flex-grow p-4 overflow-y-auto space-y-3">
                         ${state.notifications.length > 0 ? state.notifications.map(n => renderNotificationItem(n)).join('') : '<p class="text-gray-500 text-center pt-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>'}
                    </div>
                    <div class="p-4 border-t flex space-x-2">
                        <button id="panel-read-all" class="w-full bg-gray-200 py-2 rounded-lg hover:bg-gray-300">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                         <button id="panel-delete-all" class="w-full bg-red-100 text-red-700 py-2 rounded-lg hover:bg-red-200">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>
            `;
            
            // Event listeners for panel
            document.getElementById('close-notification-panel').addEventListener('click', toggleNotificationPanel);
            document.getElementById('notification-panel-backdrop').addEventListener('click', toggleNotificationPanel);
            document.getElementById('panel-read-all').addEventListener('click', () => { 
                state.notifications.forEach(n => n.read = true);
                saveData();
                render();
                renderNotificationPanel();
            });
            document.getElementById('panel-delete-all').addEventListener('click', () => { 
                showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                    state.notifications = [];
                    saveData();
                    render();
                    toggleNotificationPanel();
                });
            });
            // Attach listeners for individual items inside panel
            document.querySelectorAll('#notification-panel .mark-notification-read').forEach(btn => btn.addEventListener('click', (e) => handleMarkNotificationRead(e.currentTarget.dataset.id)));
            document.querySelectorAll('#notification-panel .delete-notification').forEach(btn => btn.addEventListener('click', (e) => handleDeleteNotification(e.currentTarget.dataset.id)));

        };

        const showAlert = (message, type = 'success') => {
            const alertId = generateId();
            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };
            const alert = `
                <div id="${alertId}" class="border-l-4 p-4 rounded-lg shadow-lg ${colors[type]}" role="alert" style="transform: translateX(120%); transition: transform 0.3s ease-in-out;">
                    <p class="font-bold">${type === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : (type === 'error' ? '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')}</p>
                    <p>${message}</p>
                </div>
            `;
            const container = document.getElementById('alert-container');
            container.insertAdjacentHTML('beforeend', alert);
            
            const alertEl = document.getElementById(alertId);
            setTimeout(() => { alertEl.style.transform = 'translateX(0)'; }, 10);
            
            setTimeout(() => {
                alertEl.style.transform = 'translateX(120%)';
                alertEl.addEventListener('transitionend', () => alertEl.remove());
            }, 4000);
        };

        const showConfirmationModal = (title, message, onConfirm) => {
            const modalId = generateId();
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-end space-x-4">
                            <button class="cancel-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button class="confirm-btn btn-primary text-white px-4 py-2 rounded-lg font-semibold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        </div>
                    </div>
                </div>
            `;
            const container = document.getElementById('modal-container');
            container.innerHTML = modalHTML;
            
            const modal = document.getElementById(modalId);
            modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
            modal.querySelector('.confirm-btn').addEventListener('click', () => {
                onConfirm();
                modal.remove();
            });
        };
        
        const showAiContentModal = (title, content) => {
            const modalId = generateId();
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">${title}</h3>
                            <button class="close-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                        </div>
                        <textarea id="ai-content-textarea" class="w-full h-48 p-2 border rounded bg-gray-50 mb-4 whitespace-pre-wrap" readonly>${content}</textarea>
                        <div class="flex justify-end space-x-4">
                            <button class="copy-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                            <button class="close-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
            
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => modal.remove()));
            modal.querySelector('.copy-btn').addEventListener('click', () => {
                const textarea = document.getElementById('ai-content-textarea');
                textarea.select();
                document.execCommand('copy');
                showAlert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß');
            });
        };


        // --- EVENT HANDLERS & LOGIC ---
        const handleTabClick = (e) => {
            if (e.target.dataset.tab) {
                state.activeTab = e.target.dataset.tab;
                render();
            }
        };

        const handleDebtorFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#debtor-id').value;
            const debtorData = {
                id: id || generateId(),
                name: form.querySelector('#debtor-name').value.trim(),
                phone: form.querySelector('#debtor-phone').value.trim(),
                email: form.querySelector('#debtor-email').value.trim(),
                idCard: form.querySelector('#debtor-id-card').value.trim(),
                address: form.querySelector('#debtor-address').value.trim(),
                createdAt: id ? state.debtors.find(d => d.id === id).createdAt : new Date().toISOString()
            };
            
            if (!debtorData.name) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error');
                return;
            }

            if (id) {
                const index = state.debtors.findIndex(d => d.id === id);
                state.debtors[index] = debtorData;
                 showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                state.debtors.push(debtorData);
                showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            
            saveData();
            render();
        };
        
        const handleDebtFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#debt-id').value;
            
            const debtData = {
                id: id || generateId(),
                debtorId: form.querySelector('#debt-debtor-id').value,
                amount: parseFloat(form.querySelector('#debt-amount').value),
                interestRate: parseFloat(form.querySelector('#debt-interest-rate').value),
                date: form.querySelector('#debt-date').value,
                dueDate: form.querySelector('#debt-due-date').value,
                type: form.querySelector('#debt-type').value,
                description: form.querySelector('#debt-description').value.trim(),
                createdAt: id ? state.debts.find(d => d.id === id).createdAt : new Date().toISOString()
            };

            if (!debtData.debtorId || !debtData.amount || !debtData.interestRate || !debtData.date || !debtData.dueDate) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            if (id) {
                const index = state.debts.findIndex(d => d.id === id);
                state.debts[index] = debtData;
                showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                state.debts.push(debtData);
                 showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            
            saveData();
            checkNotifications();
            render();
        };

        const handlePaymentFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;

            const paymentData = {
                id: generateId(),
                debtorId: form.querySelector('#payment-debtor-id').value,
                debtId: form.querySelector('#payment-debt-id').value,
                amount: parseFloat(form.querySelector('#payment-amount').value),
                date: form.querySelector('#payment-date').value,
                method: form.querySelector('#payment-method').value,
                note: form.querySelector('#payment-note').value.trim(),
                createdAt: new Date().toISOString()
            };
            
             if (!paymentData.debtorId || !paymentData.debtId || !paymentData.amount || !paymentData.date) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            state.payments.push(paymentData);
            createNotification({
                type: 'payment',
                title: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ',
                message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${state.debtors.find(d => d.id === paymentData.debtorId)?.name} ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${formatCurrency(paymentData.amount)}`
            });

            saveData();
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            render();
        };

        const handleSaveSettings = () => {
            state.settings.notifications.overdue = document.getElementById('setting-notify-overdue').checked;
            state.settings.notifications.upcoming = document.getElementById('setting-notify-upcoming').checked;
            state.settings.notifications.daysInAdvance = parseInt(document.getElementById('setting-days-advance').value) || 7;
            state.settings.googleSheetUrl = document.getElementById('google-sheet-url').value.trim();
            saveData();
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        };

        const handleEditDebtorClick = (id) => {
            const debtor = state.debtors.find(d => d.id === id);
            if (!debtor) return;
            const form = document.getElementById('debtor-form');
            form.querySelector('#debtor-id').value = debtor.id;
            form.querySelector('#debtor-name').value = debtor.name;
            form.querySelector('#debtor-phone').value = debtor.phone;
            form.querySelector('#debtor-email').value = debtor.email;
            form.querySelector('#debtor-id-card').value = debtor.idCard;
            form.querySelector('#debtor-address').value = debtor.address;
            document.getElementById('cancel-edit-debtor').classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        };
        
        const handleEditDebtClick = (id) => {
            const debt = state.debts.find(d => d.id === id);
            if (!debt) return;
            const form = document.getElementById('debt-form');
            form.querySelector('#debt-id').value = debt.id;
            form.querySelector('#debt-debtor-id').value = debt.debtorId;
            form.querySelector('#debt-amount').value = debt.amount;
            form.querySelector('#debt-interest-rate').value = debt.interestRate;
            form.querySelector('#debt-date').value = debt.date;
            form.querySelector('#debt-due-date').value = debt.dueDate;
            form.querySelector('#debt-type').value = debt.type;
            form.querySelector('#debt-description').value = debt.description;
            document.getElementById('cancel-edit-debt').classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        };

        const handleDeleteDebtorClick = (id) => {
            showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢', () => {
                state.debtors = state.debtors.filter(d => d.id !== id);
                state.debts = state.debts.filter(d => d.debtorId !== id);
                state.payments = state.payments.filter(p => !state.debts.some(d => d.id === p.debtId && d.debtorId === id));
                saveData();
                showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                render();
            });
        };
        
        const handleDeleteDebtClick = (id) => {
            showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢', () => {
                state.debts = state.debts.filter(d => d.id !== id);
                state.payments = state.payments.filter(p => p.debtId !== id);
                saveData();
                showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                render();
            });
        };
        
        const handleAnalyzeDebt = async () => {
            const resultDiv = document.getElementById('ai-analysis-result');
            const analyzeBtn = document.getElementById('analyze-debt-btn');
            if (!resultDiv || !analyzeBtn) return;
            
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...`;
            resultDiv.classList.add('hidden');

            let totalPrincipal = state.debts.reduce((sum, d) => sum + d.amount, 0);
            let totalPaid = state.payments.reduce((sum, p) => sum + p.amount, 0);
            let totalInterest = 0;
            let overdueDebtsCount = 0;
            state.debts.forEach(debt => {
                const details = calculateDebtDetails(debt.id);
                totalInterest += details.totalInterest;
                if(details.isOverdue) overdueDebtsCount++;
            });
            const totalDebtValue = totalPrincipal + totalInterest;
            const totalBalance = totalDebtValue - totalPaid;

            const prompt = `
                Act as a friendly financial advisor in Thailand. Analyze the following debt situation and provide a short, actionable summary in Thai (2-3 paragraphs). 
                Use simple language. Do not use markdown.
                - Total Debtors: ${state.debtors.length}
                - Total Outstanding Balance: ${totalBalance.toFixed(2)} THB
                - Total Principal: ${totalPrincipal.toFixed(2)} THB
                - Number of Overdue Debts: ${overdueDebtsCount}
                - Total Debts: ${state.debts.length}
                
                Start with a brief overview, then mention the key risk (like overdue debts), and finally suggest one or two simple actions the user can take.
            `;
            
            const analysisText = await callGeminiAPI(prompt);

            if (analysisText) {
                resultDiv.textContent = analysisText;
                resultDiv.classList.remove('hidden');
            }

            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        };

        const handleGenerateReminder = async (debtId) => {
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt) return;
            const debtor = state.debtors.find(d => d.id === debt.debtorId);
            const { balance, isOverdue, daysOverdue } = calculateDebtDetails(debtId);

            let tone = "polite and gentle reminder";
            if (isOverdue) {
                tone = "polite but firm reminder";
                if (daysOverdue > 30) {
                    tone = "more urgent and formal final reminder";
                }
            }
            
            const prompt = `
                Generate a debt reminder message in Thai. The tone should be a ${tone}.
                - Debtor's Name: ${debtor.name}
                - Outstanding Amount: ${formatCurrency(balance)}
                - Due Date: ${formatDate(debt.dueDate)}
                - Your Name/Company Name: (Leave a blank like "[‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì]")

                The message should be concise and clear. Include the key details. Do not use markdown.
                Example structure:
                ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ
                ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ñ‡∏∏‡∏ì ${debtor.name},
                ... body of the message ...
                ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠,
                [‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì]
            `;
            
            showAiContentModal("‚ú® AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ß‡∏á‡∏ñ‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ...");
            
            const reminderText = await callGeminiAPI(prompt);

            if (reminderText) {
                showAiContentModal("‚ú® ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ß‡∏á‡∏ñ‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ AI)", reminderText);
            } else {
                document.getElementById('modal-container').innerHTML = ''; // Close loading modal on error
            }
        };

        const updateNotificationBell = () => {
            const badge = document.getElementById('notification-badge');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        };

        const toggleNotificationPanel = () => {
            const panel = document.getElementById('notification-panel');
            const backdrop = document.getElementById('notification-panel-backdrop');
            if (panel && panel.classList.contains('open')) {
                panel.classList.remove('open');
                backdrop.classList.add('hidden');
            } else {
                renderNotificationPanel(); // Re-render to ensure it's up to date
                document.getElementById('notification-panel')?.classList.add('open');
                document.getElementById('notification-panel-backdrop')?.classList.remove('hidden');
            }
        };
        
        const handleMarkNotificationRead = (id) => {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveData();
                render();
                renderNotificationPanel(); // Re-render panel
            }
        };

        const handleDeleteNotification = (id) => {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
            render();
            renderNotificationPanel(); // Re-render panel
        };
        
        const updateDebtsForPaymentForm = (debtorId) => {
            const debtSelect = document.getElementById('payment-debt-id');
            const balanceInfo = document.getElementById('debtor-balance-info');
            if (!debtorId) {
                debtSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô --</option>';
                debtSelect.disabled = true;
                balanceInfo.textContent = '';
                return;
            }
            
            const debtorDebts = state.debts.filter(d => d.debtorId === debtorId);
            if (debtorDebts.length > 0) {
                debtSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ --</option>';
                debtorDebts.forEach(debt => {
                    const { balance } = calculateDebtDetails(debt.id);
                    if (balance > 0) {
                        const optionText = `${debt.description || `‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô ${formatCurrency(debt.amount)}`} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${formatCurrency(balance)})`;
                        debtSelect.innerHTML += `<option value="${debt.id}">${optionText}</option>`;
                    }
                });
                debtSelect.disabled = false;
            } else {
                debtSelect.innerHTML = '<option value="">-- ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ --</option>';
                debtSelect.disabled = true;
            }

            const summary = getDebtorSummary(debtorId);
            balanceInfo.textContent = `(‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${formatCurrency(summary.totalBalance)})`;
        };

        // --- NOTIFICATION SYSTEM ---
        const createNotification = (data) => {
            const newNotification = {
                id: generateId(),
                read: false,
                createdAt: new Date().toISOString(),
                ...data
            };
            // Add to the beginning of the array
            state.notifications.unshift(newNotification);
            updateNotificationBell();
        };

        const checkNotifications = () => {
            const today = new Date();
            const { overdue: checkOverdue, upcoming: checkUpcoming, daysInAdvance } = state.settings.notifications;

            state.debts.forEach(debt => {
                const { balance, isOverdue, daysOverdue } = calculateDebtDetails(debt.id);
                const debtorName = state.debtors.find(d => d.id === debt.debtorId)?.name || 'N/A';
                
                // Check for existing notification for this debt
                const existingOverdue = state.notifications.find(n => n.debtId === debt.id && n.type === 'overdue');
                const existingUpcoming = state.notifications.find(n => n.debtId === debt.id && n.type === 'upcoming');

                if (balance > 0) {
                    if (checkOverdue && isOverdue && !existingOverdue) {
                         createNotification({
                             type: 'overdue', debtId: debt.id, title: `‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞`,
                             message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${debtorName} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ ${daysOverdue} ‡∏ß‡∏±‡∏ô`
                         });
                    }
                    const daysUntilDue = getDaysDifference(debt.dueDate, today);
                    if (checkUpcoming && !isOverdue && daysUntilDue >= 0 && daysUntilDue <= daysInAdvance && !existingUpcoming) {
                        createNotification({
                             type: 'upcoming', debtId: debt.id, title: `‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î`,
                             message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${debtorName} ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${daysUntilDue} ‡∏ß‡∏±‡∏ô`
                         });
                    }
                }
            });
            saveData();
            render();
        };

        // --- EXCEL Import/Export ---
        const handleExport = (type) => {
            let data, filename;
            if (type === 'debtors') {
                data = state.debtors.map(d => ({
                    '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': d.name, '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå': d.phone, '‡∏≠‡∏µ‡πÄ‡∏°‡∏•': d.email,
                    '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': d.idCard, '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': d.address, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°': formatDate(d.createdAt)
                }));
                filename = 'debtors_export.xlsx';
            } else if (type === 'debts') {
                 data = state.debts.map(d => {
                    const debtor = state.debtors.find(debtor => debtor.id === d.debtorId);
                    const { balance } = calculateDebtDetails(d.id);
                    return {
                        '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ': debtor?.name || 'N/A', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô': d.amount,
                        '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%)': d.interestRate, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ': formatDate(d.date),
                        '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î': formatDate(d.dueDate), '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ': d.type,
                        '‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô': balance, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': d.description
                    };
                });
                filename = 'debts_export.xlsx';
            } else if (type === 'payments') {
                data = state.payments.map(p => {
                    const debt = state.debts.find(d => d.id === p.debtId);
                    const debtor = state.debtors.find(d => d.id === debt?.debtorId);
                    return {
                        '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ': debtor?.name || 'N/A', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞': p.amount,
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞': formatDate(p.date), '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞': p.method,
                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': p.note, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å': formatDate(p.createdAt)
                    };
                });
                filename = 'payments_export.xlsx';
            }
            if(data && data.length > 0) {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, filename);
                showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'info');
            }
        };

        const handleImport = (file, type) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    let count = 0;
                    if (type === 'debtors') {
                         json.forEach(row => {
                            const name = row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || row['name'];
                            if (name) {
                                state.debtors.push({
                                    id: generateId(), name: name, phone: row['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || row['phone'] || '',
                                    email: row['‡∏≠‡∏µ‡πÄ‡∏°‡∏•'] || row['email'] || '', idCard: row['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || row['idCard'] || '',
                                    address: row['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || row['address'] || '', createdAt: new Date().toISOString()
                                });
                                count++;
                            }
                         });
                    }
                    saveData();
                    showAlert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    render();
                } catch (error) {
                    console.error("Import error:", error);
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // --- Google Sheets Integration ---
        const updateSyncStatus = (status) => {
            state.syncStatus = status;
            const indicator = document.getElementById('sync-status-indicator');
            if(indicator) {
                indicator.innerHTML = {
                    syncing: `<span class="flex items-center text-blue-600"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...</span>`,
                    success: `<span class="text-green-600">‚úî ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`,
                    error: `<span class="text-red-600">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>`,
                    idle: `<span class="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`
                }[status];
            }
        };

        const syncToGoogleSheets = async () => {
            if (!state.settings.googleSheetUrl) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            updateSyncStatus('syncing');
            try {
                const payload = {
                    debtors: state.debtors, debts: state.debts, payments: state.payments,
                };
                await fetch(state.settings.googleSheetUrl, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), redirect: 'follow'
                });
                updateSyncStatus('success');
                showAlert('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error("Sync error:", error);
                updateSyncStatus('error');
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        };

        const loadFromGoogleSheets = async () => {
             if (!state.settings.googleSheetUrl) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            updateSyncStatus('syncing');
            try {
                 const response = await fetch(state.settings.googleSheetUrl);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 const data = await response.json();
                 state.debtors = data.debtors || [];
                 state.debts = data.debts || [];
                 state.payments = data.payments || [];
                 saveData();
                 updateSyncStatus('success');
                 showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                 render();
            } catch (error) {
                 console.error("Load error:", error);
                updateSyncStatus('error');
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        };

        // --- ATTACH EVENT LISTENERS ---
        const attachEventListeners = () => {
            document.getElementById('tabs-container').addEventListener('click', handleTabClick);
            document.getElementById('notification-bell').addEventListener('click', toggleNotificationPanel);

            const activeTab = state.activeTab;
            if (activeTab === 'dashboard') {
                document.getElementById('analyze-debt-btn')?.addEventListener('click', handleAnalyzeDebt);
            } else if (activeTab === 'debtors') {
                document.getElementById('debtor-form')?.addEventListener('submit', handleDebtorFormSubmit);
                document.querySelectorAll('.edit-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtorClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtorClick(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debtor')?.addEventListener('click', () => {
                    document.getElementById('debtor-form').reset();
                    document.getElementById('debtor-id').value = '';
                    document.getElementById('cancel-edit-debtor').classList.add('hidden');
                });
                document.getElementById('export-debtors-btn')?.addEventListener('click', () => handleExport('debtors'));
                document.getElementById('import-debtors-btn')?.addEventListener('click', () => document.getElementById('debtors-file-input').click());
                document.getElementById('debtors-file-input')?.addEventListener('change', (e) => handleImport(e.target.files[0], 'debtors'));
            } else if (activeTab === 'debts') {
                document.getElementById('debt-form')?.addEventListener('submit', handleDebtFormSubmit);
                document.querySelectorAll('.edit-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.generate-reminder-btn').forEach(btn => btn.addEventListener('click', (e) => handleGenerateReminder(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debt')?.addEventListener('click', () => {
                    document.getElementById('debt-form').reset();
                    document.getElementById('debt-id').value = '';
                    document.getElementById('cancel-edit-debt').classList.add('hidden');
                });
                document.getElementById('export-debts-btn')?.addEventListener('click', () => handleExport('debts'));
            } else if (activeTab === 'payments') {
                document.getElementById('payment-form')?.addEventListener('submit', handlePaymentFormSubmit);
                document.getElementById('payment-debtor-id')?.addEventListener('change', (e) => updateDebtsForPaymentForm(e.target.value));
                 document.getElementById('export-payments-btn')?.addEventListener('click', () => handleExport('payments'));
            } else if (activeTab === 'notifications') {
                document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
                document.querySelectorAll('#notifications-list .mark-notification-read').forEach(btn => btn.addEventListener('click', (e) => handleMarkNotificationRead(e.currentTarget.dataset.id)));
                document.querySelectorAll('#notifications-list .delete-notification').forEach(btn => btn.addEventListener('click', (e) => handleDeleteNotification(e.currentTarget.dataset.id)));
                document.getElementById('read-all-notifications')?.addEventListener('click', () => {
                    state.notifications.forEach(n => n.read = true);
                    saveData();
                    render();
                });
                document.getElementById('delete-all-notifications')?.addEventListener('click', () => {
                     showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                        state.notifications = [];
                        saveData();
                        render();
                    });
                });
                document.getElementById('load-from-sheets')?.addEventListener('click', loadFromGoogleSheets);
                document.getElementById('sync-to-sheets')?.addEventListener('click', syncToGoogleSheets);
            }
        };

        // --- INITIALIZATION ---
        const init = () => {
            loadData();
            render();
            checkNotifications(); // Initial check
            setInterval(checkNotifications, 5 * 60 * 1000); // Check every 5 minutes
            
            setInterval(() => {
                if (state.settings.googleSheetUrl && navigator.onLine) {
                    syncToGoogleSheets();
                }
            }, 5 * 60 * 1000);
        };

        init();
    });
    </script>

</body>
</html>

