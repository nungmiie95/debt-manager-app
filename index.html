<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.12 (Cloud-Based)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .gradient-bg {
            background-image: linear-gradient(to right, #667eea, #764ba2);
        }
        .tab-active {
            border-bottom: 3px solid #fff;
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .tab-inactive {
            color: #e0e0e0;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .notification-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .notification-panel.open {
            transform: translateX(0);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.4);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #667eea, #764ba2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
             background-image: none;
             background-color: #a0aec0;
             cursor: not-allowed;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #667eea;
        }
        .file-input-label {
            cursor: pointer;
            border: 2px dashed #cbd5e0;
        }
        .file-input-label:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        /* Sync Status Pill */
        .sync-status-pill {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .sync-status-pill.pending { background-color: #fef3c7; color: #92400e; } /* yellow */
        .sync-status-pill.syncing { background-color: #dbeafe; color: #1e40af; } /* blue */
        .sync-status-pill.success { background-color: #d1fae5; color: #065f46; } /* green */
        .sync-status-pill.error { background-color: #fee2e2; color: #991b1b; }   /* red */
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-xl md:text-2xl font-bold">üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.12</h1>
                    <div id="global-sync-status" class="ml-3"></div>
                </div>
                <div class="relative">
                    <button id="notification-bell" class="relative focus:outline-none">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
            <!-- Tabs Navigation -->
            <nav id="tabs-container" class="bg-white/10">
                <div class="container mx-auto px-4 flex space-x-2 overflow-x-auto">
                    <button data-tab="dashboard" class="py-3 px-4 font-semibold whitespace-nowrap tab-active">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    <button data-tab="debtors" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="debts" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="payments" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="settings" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 md:p-6">
            <div id="tab-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </main>

    </div>

    <!-- Modals & Overlays -->
    <div id="modal-container"></div>
    <div id="alert-container" class="fixed top-20 right-5 z-50 space-y-2"></div>
    <div id="notification-panel-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let state = {
            debtors: [],
            debts: [],
            payments: [],
            notifications: [],
            settings: {
                notifications: { overdue: true, upcoming: true, daysInAdvance: 7 },
                googleSheetUrl: ''
            },
            activeTab: 'dashboard',
            syncStatus: 'idle', // idle, pending, syncing, success, error
            debtorsSearchQuery: '',
            debtsSearchQuery: ''
        };

        // --- DEBOUNCER for auto-saving ---
        let saveTimeout;
        const debounceSave = () => {
            clearTimeout(saveTimeout);
            updateSyncStatus('pending');
            saveTimeout = setTimeout(() => {
                saveDataToSheets(false); // auto-save doesn't show success alert
            }, 2500);
        };
        
        // --- DATA HANDLING ---
        const saveData = () => {
            localStorage.setItem('debtManagerData_backup', JSON.stringify(state)); // Use localStorage ONLY as a backup
            if (state.settings.googleSheetUrl) {
                debounceSave();
            }
        };

        const loadLocalBackup = () => {
            const data = localStorage.getItem('debtManagerData_backup');
            if (data) {
                const parsed = JSON.parse(data);
                state.debtors = parsed.debtors || [];
                state.debts = parsed.debts || [];
                state.payments = parsed.payments || [];
                state.notifications = parsed.notifications || [];
            }
        };

        // --- UTILITY FUNCTIONS ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount || 0);
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
        const getDaysDifference = (date1, date2) => Math.round((new Date(date1) - new Date(date2)) / (1000 * 60 * 60 * 24));
        
        // --- UI UTILITIES ---
        const showLoadingOverlay = (message) => {
            let overlay = document.getElementById('loading-overlay');
            if (overlay) return;
            overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop text-white';
            overlay.innerHTML = `<div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto"></div><p class="mt-4">${message}</p></div>`;
            document.body.appendChild(overlay);
        };

        const hideLoadingOverlay = () => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.remove();
        };

        const showAlert = (message, type = 'success') => {
             const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
             const alertEl = document.createElement('div');
             alertEl.className = `p-4 text-white ${colors[type]} rounded-lg shadow-lg animate-fade-in-down`;
             alertEl.textContent = message;
             document.getElementById('alert-container').appendChild(alertEl);
             setTimeout(() => { alertEl.remove(); }, 4000);
        };

        const showConfirmationModal = (title, message, onConfirm) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
                    <h3 class="text-lg font-bold mb-2">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="modal-confirm" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    </div>
                </div>`;
            document.getElementById('modal-container').appendChild(modal);
            document.getElementById('modal-cancel').addEventListener('click', () => modal.remove());
            document.getElementById('modal-confirm').addEventListener('click', () => { onConfirm(); modal.remove(); });
        };

        // --- CALCULATION LOGIC ---
        const calculateDebtDetails = (debtId) => {
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt) return { totalInterest: 0, totalPaid: 0, balance: 0, isOverdue: false, daysOverdue: 0 };
            
            const startDate = new Date(debt.date);
            const today = new Date();
            today.setHours(0,0,0,0);
            const monthsDiff = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
            const totalInterest = monthsDiff > 0 ? debt.amount * (debt.interestRate / 100) * monthsDiff : 0;
            const totalDebt = debt.amount + totalInterest;
            const totalPaid = state.payments.filter(p => p.debtId === debtId).reduce((sum, p) => sum + p.amount, 0);
            const balance = totalDebt - totalPaid;
            const dueDate = new Date(debt.dueDate);
            dueDate.setHours(0,0,0,0);
            const isOverdue = dueDate < today && balance > 0;
            const daysOverdue = isOverdue ? getDaysDifference(today, debt.dueDate) : 0;
            
            return { totalInterest, totalPaid, balance, totalDebt, isOverdue, daysOverdue };
        };

        const getDebtorSummary = (debtorId) => ({
            totalBalance: state.debts
                .filter(d => d.debtorId === debtorId)
                .reduce((sum, debt) => sum + calculateDebtDetails(debt.id).balance, 0)
        });

        // --- UI RENDERING ---
        const render = () => {
            const tab = state.activeTab;
            const contentEl = document.getElementById('tab-content');
            
            document.querySelectorAll('#tabs-container button').forEach(button => {
                button.classList.toggle('tab-active', button.dataset.tab === tab);
                button.classList.toggle('tab-inactive', button.dataset.tab !== tab);
            });
            
            const renderMap = {
                dashboard: renderDashboard,
                debtors: renderDebtors,
                debts: renderDebts,
                payments: renderPayments,
                settings: renderSettings
            };
            
            contentEl.innerHTML = renderMap[tab] ? renderMap[tab]() : `<p>Error</p>`;
            attachEventListeners();
            updateNotificationBell();
            updateSyncStatus(state.syncStatus);
        };
        
        const renderDashboard = () => {
            let totalPrincipal = state.debts.reduce((sum, d) => sum + d.amount, 0);
            let totalPaid = state.payments.reduce((sum, p) => sum + p.amount, 0);
            let totalInterest = 0, overdueDebtsCount = 0;
            let upcomingDebts = [];
            
            state.debts.forEach(debt => {
                const details = calculateDebtDetails(debt.id);
                totalInterest += details.totalInterest;
                if (details.isOverdue) overdueDebtsCount++;
                const daysUntilDue = getDaysDifference(debt.dueDate, new Date());
                if (daysUntilDue >= 0 && daysUntilDue <= 30 && details.balance > 0) {
                    upcomingDebts.push({ ...debt, daysUntilDue, balance: details.balance });
                }
            });

            const totalDebtValue = totalPrincipal + totalInterest;
            const totalBalance = totalDebtValue - totalPaid;
            const paymentProgress = totalDebtValue > 0 ? (totalPaid / totalDebtValue) * 100 : 0;
            
            const overdueAlert = overdueDebtsCount > 0 ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 animate-pulse"><p class="font-bold">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô!</p><p>‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${overdueDebtsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>` : '';
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3><p class="text-2xl font-bold">${state.debtors.length} ‡∏Ñ‡∏ô</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üí∞ ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô)</h3><p class="text-2xl font-bold">${formatCurrency(totalPrincipal)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°</h3><p class="text-2xl font-bold">${formatCurrency(totalInterest)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500 text-green-600">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</h3><p class="text-2xl font-bold text-green-600">${formatCurrency(totalPaid)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500 text-red-600">‚ùó ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h3><p class="text-2xl font-bold text-red-600">${formatCurrency(totalBalance)}</p></div>
                </div>
                ${overdueAlert}
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</th><th class="px-4 py-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="px-4 py-2">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô</th></tr></thead>
                                <tbody>
                                    ${upcomingDebts.length > 0 ? upcomingDebts.sort((a,b) => a.daysUntilDue - b.daysUntilDue).map(debt => `
                                        <tr class="bg-white border-b"><td class="px-4 py-2 font-medium">${state.debtors.find(d => d.id === debt.debtorId)?.name || 'N/A'}</td>
                                        <td class="px-4 py-2">${formatCurrency(debt.balance)}</td>
                                        <td class="px-4 py-2"><span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${debt.daysUntilDue} ‡∏ß‡∏±‡∏ô</span></td></tr>
                                    `).join('') : '<tr><td colspan="3" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-gray-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${formatCurrency(totalPaid)} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${formatCurrency(totalDebtValue)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 my-2"><div class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full" style="width: ${paymentProgress.toFixed(2)}%"></div></div>
                        <p class="text-right font-bold">${paymentProgress.toFixed(2)}%</p>
                    </div>
                </div>`;
        };
        
        const renderDebtors = () => {
            const filteredDebtors = state.debtors.filter(d => d.name.toLowerCase().includes(state.debtorsSearchQuery.toLowerCase()));
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4" id="debtor-form-title">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                        <form id="debtor-form" class="space-y-4">
                            <input type="hidden" id="debtor-id">
                            <div><label for="debtor-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*</label><input type="text" id="debtor-name" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div>
                            <div><label for="debtor-phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="debtor-phone" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="debtor-email" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-id-card" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="debtor-id-card" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-address" class="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><textarea id="debtor-address" rows="3" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <div class="flex items-center space-x-2"><button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button type="button" id="cancel-edit-debtor" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (${filteredDebtors.length})</h3><input type="text" id="debtors-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ..." class="form-input rounded-md border-gray-300 shadow-sm w-1/2" value="${state.debtorsSearchQuery}"></div>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            ${filteredDebtors.length > 0 ? filteredDebtors.map(debtor => `<div class="border p-4 rounded-lg bg-gray-50"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg">${debtor.name}</h4><p class="text-sm text-gray-600">${debtor.phone || ''}</p><p class="text-sm text-gray-600">${debtor.email || ''}</p></div><div class="flex space-x-2"><button data-id="${debtor.id}" class="edit-debtor-btn p-2 text-gray-500 hover:text-blue-600">‚úèÔ∏è</button><button data-id="${debtor.id}" class="delete-debtor-btn p-2 text-gray-500 hover:text-red-600">üóëÔ∏è</button></div></div><div class="mt-2 pt-2 border-t"><p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="font-bold text-red-600">${formatCurrency(getDebtorSummary(debtor.id).totalBalance)}</span></p></div></div>`).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        const renderDebts = () => {
            const filteredDebts = state.debts.filter(debt => { const debtor = state.debtors.find(d => d.id === debt.debtorId); return debtor && debtor.name.toLowerCase().includes(state.debtsSearchQuery.toLowerCase()); });
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4" id="debt-form-title">üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                        <form id="debt-form" class="space-y-4">
                            <input type="hidden" id="debt-id">
                            <div><label for="debt-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label><select id="debt-debtor-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>${state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}</select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="debt-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)*</label><input type="number" id="debt-amount" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="debt-interest-rate" class="block text-sm font-medium text-gray-700">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)*</label><input type="number" id="debt-interest-rate" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div></div>
                             <div class="grid grid-cols-2 gap-4"><div><label for="debt-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ*</label><input type="date" id="debt-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="debt-due-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î*</label><input type="date" id="debt-due-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div></div>
                            <div><label for="debt-type" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ</label><select id="debt-type" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                            <div><label for="debt-evidence-file" class="block text-sm font-medium text-gray-700">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/PDF)</label><label for="debt-evidence-file" class="file-input-label mt-1 flex justify-center px-6 pt-5 pb-6 rounded-md"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><p class="text-sm text-gray-600" id="debt-evidence-name">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p></div></label><input type="file" id="debt-evidence-file" class="hidden" accept="image/*,.pdf"></div>
                            <div><label for="debt-description" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="debt-description" rows="2" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <div class="flex items-center space-x-2"><button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button type="button" id="cancel-edit-debt" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${filteredDebts.length})</h3><input type="text" id="debts-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ..." class="form-input rounded-md border-gray-300 shadow-sm w-1/2" value="${state.debtsSearchQuery}"></div>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            ${filteredDebts.length > 0 ? filteredDebts.map(debt => { const details = calculateDebtDetails(debt.id); const debtor = state.debtors.find(d => d.id === debt.debtorId); const overdueBadge = details.isOverdue ? `<span class="bg-red-100 text-red-800 text-xs font-bold mr-2 px-2.5 py-0.5 rounded-full">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${details.daysOverdue} ‡∏ß‡∏±‡∏ô</span>` : ''; return `
                                    <div class="border p-4 rounded-lg ${details.isOverdue ? 'bg-red-50' : 'bg-gray-50'}"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg">${debtor?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠'} ${overdueBadge}</h4><p class="text-sm text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô: ${formatCurrency(debt.amount)} | ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (${debt.interestRate}%/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</p><p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ: ${formatDate(debt.date)} | ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatDate(debt.dueDate)}</p></div><div class="flex space-x-2">${debt.evidence ? `<button data-id="${debt.id}" data-type="debt" class="view-evidence-btn p-2 text-gray-500 hover:text-blue-600">üìé</button>` : ''}<button data-id="${debt.id}" class="edit-debt-btn p-2 text-gray-500 hover:text-blue-600">‚úèÔ∏è</button><button data-id="${debt.id}" class="delete-debt-btn p-2 text-gray-500 hover:text-red-600">üóëÔ∏è</button></div></div><div class="mt-3 pt-3 border-t grid grid-cols-3 gap-2 text-sm text-center"><div><span class="block text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="font-semibold">${formatCurrency(details.totalDebt)}</span></div><div><span class="block text-gray-500 text-green-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span><span class="font-semibold text-green-600">${formatCurrency(details.totalPaid)}</span></div><div><span class="block text-gray-500 text-red-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><span class="font-semibold text-red-600">${formatCurrency(details.balance)}</span></div></div></div>`; }).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        const renderPayments = () => {
             const debtorOptions = state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
             return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <form id="payment-form" class="space-y-4">
                            <div><label for="payment-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label><select id="payment-debtor-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>${debtorOptions}</select></div>
                            <div><label for="payment-debt-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ*</label><select id="payment-debt-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required disabled><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô --</option></select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="payment-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô*</label><input type="number" id="payment-amount" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="payment-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞*</label><input type="date" id="payment-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div></div>
                            <div><label for="payment-method" class="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label><select id="payment-method" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"><option>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option><option>‡πÄ‡∏ä‡πá‡∏Ñ</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                             <div><label for="payment-evidence-file" class="block text-sm font-medium text-gray-700">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡∏™‡∏•‡∏¥‡∏õ)</label><label for="payment-evidence-file" class="file-input-label mt-1 flex justify-center px-6 pt-5 pb-6 rounded-md"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><p class="text-sm text-gray-600" id="payment-evidence-name">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p></div></label><input type="file" id="payment-evidence-file" class="hidden" accept="image/*,.pdf"></div>
                            <div><label for="payment-note" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="payment-note" rows="2" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                         <h3 class="text-lg font-semibold mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                         <div class="relative pl-4 border-l-2 border-gray-200 max-h-[60vh] overflow-y-auto pr-2">
                             ${state.payments.length > 0 ? [...state.payments].reverse().map(p => { const debtor = state.debtors.find(d => d.id === p.debtorId); return `<div class="mb-6 relative timeline-item"><div class="font-semibold">${debtor?.name || 'N/A'}</div><time class="text-sm font-normal leading-none text-gray-400">${formatDate(p.date)}</time><p class="text-base font-normal text-gray-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="font-bold text-green-600">${formatCurrency(p.amount)}</span> ‡∏ú‡πà‡∏≤‡∏ô ${p.method}.</p>${p.note ? `<p class="text-sm text-gray-500 bg-gray-100 p-2 rounded-md mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${p.note}</p>` : ''}${p.evidence ? `<button data-id="${p.id}" data-type="payment" class="view-evidence-btn text-sm text-blue-600 hover:underline mt-1">üìé ‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>` : ''}</div>` }).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>'}
                         </div>
                    </div>
                </div>
             `;
        };
        const renderSettings = () => {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="card bg-white p-6 rounded-lg shadow mb-6">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">üîÑ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheets</h3>
                        <p class="text-gray-600 mb-4">‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Google Sheets ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        <div>
                            <label for="google-sheet-url" class="block text-sm font-medium text-gray-700">Google Apps Script URL</label>
                            <input type="url" id="google-sheet-url" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" value="${state.settings.googleSheetUrl || ''}">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ URL, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏° <span class="font-bold">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></p>
                        <div class="mt-4 flex flex-col sm:flex-row gap-2">
                             <button id="save-settings-btn" class="flex-1 btn-primary text-white font-bold py-2 px-4 rounded-md">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                             <button id="save-to-sheets-manual" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">üì§ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>
                    
                    <div class="card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between"><span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span><input type="checkbox" id="setting-overdue" class="form-checkbox h-5 w-5 text-purple-600" ${state.settings.notifications.overdue ? 'checked' : ''}/></label>
                            <label class="flex items-center justify-between"><span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span><input type="checkbox" id="setting-upcoming" class="form-checkbox h-5 w-5 text-purple-600" ${state.settings.notifications.upcoming ? 'checked' : ''}/></label>
                            <div>
                                <label for="setting-days" class="block text-sm font-medium text-gray-700">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô)</label>
                                <input type="number" id="setting-days" min="1" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" value="${state.settings.notifications.daysInAdvance}">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderNotificationPanel = () => { /* ... same ... */ };
        
        // --- GOOGLE SHEETS & DRIVE HANDLING ---
        const updateSyncStatus = (status) => {
            state.syncStatus = status;
            const statusEl = document.getElementById('global-sync-status');
            if (!statusEl) return;
            const statusMap = {
                idle:    { text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', class: 'success' },
                pending: { text: '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', class: 'pending' },
                syncing: { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', class: 'syncing' },
                success: { text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', class: 'success' },
                error:   { text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', class: 'error' },
            };
            const current = statusMap[status] || statusMap.idle;
            statusEl.innerHTML = `<span class="sync-status-pill ${current.class}">${current.text}</span>`;
        };

        const uploadFileToDrive = async (file) => { /* ... same as previous version ... */ };
        
        const saveDataToSheets = async (showSuccessAlert = false) => {
            if (!state.settings.googleSheetUrl) {
                updateSyncStatus('error');
                if (showSuccessAlert) showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            clearTimeout(saveTimeout);
            updateSyncStatus('syncing');
            try {
                const payload = { action: 'syncData', data: { debtors: state.debtors, debts: state.debts, payments: state.payments } };
                const res = await fetch(state.settings.googleSheetUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                if (!res.ok) throw new Error(`Server returned status: ${res.status}`);
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
                updateSyncStatus('success');
                if (showSuccessAlert) showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error("Save to Sheets error:", error);
                updateSyncStatus('error');
                if (showSuccessAlert) showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`, 'error');
            }
        };

        const loadFromGoogleSheets = async () => {
            if (!state.settings.googleSheetUrl) return;
            updateSyncStatus('syncing');
            try {
                 const res = await fetch(`${state.settings.googleSheetUrl}?action=getData`);
                 if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                 const result = await res.json();
                 if (result.status !== 'success') throw new Error(result.message);
                 state.debtors = result.data.debtors || [];
                 state.debts = result.data.debts || [];
                 state.payments = result.data.payments || [];
                 // Do not save to local storage here, as sheets is the source of truth
                 updateSyncStatus('success');
                 showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                 console.error("Load error:", error);
                 updateSyncStatus('error');
                 showAlert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ: ${error.message} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`, 'error');
                 loadLocalBackup(); // Load from backup if cloud fails
            }
        };

        // --- EVENT HANDLERS & LOGIC ---
        const handleTabClick = (e) => { if (e.target.dataset.tab) { state.activeTab = e.target.dataset.tab; render(); } };
        
        const handleDebtorFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#debtor-id').value;
            const debtorData = {
                id: id || generateId(), name: form.querySelector('#debtor-name').value.trim(), phone: form.querySelector('#debtor-phone').value.trim(), email: form.querySelector('#debtor-email').value.trim(),
                idCard: form.querySelector('#debtor-id-card').value.trim(), address: form.querySelector('#debtor-address').value.trim(),
                createdAt: id ? state.debtors.find(d => d.id === id).createdAt : new Date().toISOString()
            };
            if (!debtorData.name) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error'); return; }
            if (id) { state.debtors[state.debtors.findIndex(d => d.id === id)] = debtorData; showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            else { state.debtors.push(debtorData); showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            saveData(); render();
        };

        const handleDebtFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#debt-id').value, submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                const fileInput = form.querySelector('#debt-evidence-file');
                let evidenceUrl = id ? state.debts.find(d => d.id === id).evidence : null;
                if (fileInput.files[0]) { submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...'; evidenceUrl = await uploadFileToDrive(fileInput.files[0]); }
                const debtData = {
                    id: id || generateId(), debtorId: form.querySelector('#debt-debtor-id').value, amount: parseFloat(form.querySelector('#debt-amount').value), interestRate: parseFloat(form.querySelector('#debt-interest-rate').value),
                    date: form.querySelector('#debt-date').value, dueDate: form.querySelector('#debt-due-date').value, type: form.querySelector('#debt-type').value,
                    description: form.querySelector('#debt-description').value.trim(), createdAt: id ? state.debts.find(d => d.id === id).createdAt : new Date().toISOString(), evidence: evidenceUrl
                };
                if (!debtData.debtorId || !debtData.amount || !debtData.interestRate || !debtData.date || !debtData.dueDate) { throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); }
                if (id) { state.debts[state.debts.findIndex(d => d.id === id)] = debtData; showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
                else { state.debts.push(debtData); showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
                checkNotifications(); saveData(); render();
            } catch (error) { showAlert(error.message, 'error'); }
            finally { submitBtn.disabled = false; submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; }
        };
        
        const handlePaymentFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target, submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                const fileInput = form.querySelector('#payment-evidence-file');
                let evidenceUrl = null;
                if (fileInput.files[0]) { submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...'; evidenceUrl = await uploadFileToDrive(fileInput.files[0]); }
                const paymentData = {
                    id: generateId(), debtorId: form.querySelector('#payment-debtor-id').value, debtId: form.querySelector('#payment-debt-id').value, amount: parseFloat(form.querySelector('#payment-amount').value),
                    date: form.querySelector('#payment-date').value, method: form.querySelector('#payment-method').value, note: form.querySelector('#payment-note').value.trim(), createdAt: new Date().toISOString(), evidence: evidenceUrl
                };
                if (!paymentData.debtorId || !paymentData.debtId || !paymentData.amount || !paymentData.date) { throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); }
                state.payments.push(paymentData);
                createNotification({ type: 'payment', title: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ', message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${state.debtors.find(d=>d.id===paymentData.debtorId)?.name} ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ${formatCurrency(paymentData.amount)}` });
                showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); saveData(); render();
            } catch (error) { showAlert(error.message, 'error'); }
            finally { submitBtn.disabled = false; submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞'; }
        };

        const handleSaveSettings = () => {
            state.settings.notifications.overdue = document.getElementById('setting-overdue').checked;
            state.settings.notifications.upcoming = document.getElementById('setting-upcoming').checked;
            state.settings.notifications.daysInAdvance = parseInt(document.getElementById('setting-days').value) || 7;
            const oldUrl = state.settings.googleSheetUrl;
            state.settings.googleSheetUrl = document.getElementById('google-sheet-url').value.trim();
            
            localStorage.setItem('debtManagerData_backup', JSON.stringify(state)); // Save settings immediately
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');

            if (state.settings.googleSheetUrl && oldUrl !== state.settings.googleSheetUrl) {
                showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...', 'info');
                init(); // Re-initialize to load data from the new URL
            }
        };

        const handleEditDebtorClick = (id) => { /* ... same ... */ };
        const handleEditDebtClick = (id) => { /* ... same ... */ };
        const handleDeleteDebtorClick = (id) => { /* ... same ... */ };
        const handleDeleteDebtClick = (id) => { /* ... same ... */ };
        const updateNotificationBell = () => { /* ... same ... */ };
        const toggleNotificationPanel = () => { /* ... same ... */ };
        const handleMarkNotificationRead = (id) => { /* ... same ... */ };
        const handleDeleteNotification = (id) => { /* ... same ... */ };
        const updateDebtsForPaymentForm = (debtorId) => { /* ... same ... */ };
        const createNotification = (data) => { /* ... same ... */ };
        const checkNotifications = () => { /* ... same ... */ };
        
        const attachEventListeners = () => {
            document.getElementById('tabs-container').addEventListener('click', handleTabClick);
            document.getElementById('notification-bell').addEventListener('click', toggleNotificationPanel);
            document.querySelectorAll('.view-evidence-btn').forEach(btn => btn.addEventListener('click', e => { const { type, id } = e.currentTarget.dataset; const item = state[type === 'debt' ? 'debts' : 'payments'].find(i => i.id === id); if (item && item.evidence) window.open(item.evidence, '_blank'); }));
            const activeTab = state.activeTab;
            if (activeTab === 'debtors') {
                document.getElementById('debtor-form')?.addEventListener('submit', handleDebtorFormSubmit);
                document.querySelectorAll('.edit-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtorClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtorClick(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debtor')?.addEventListener('click', () => { document.getElementById('debtor-form').reset(); document.getElementById('debtor-id').value = ''; document.getElementById('debtor-form-title').textContent = 'üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà'; document.getElementById('cancel-edit-debtor').classList.add('hidden'); });
                document.getElementById('debtors-search-input')?.addEventListener('input', e => { state.debtorsSearchQuery = e.target.value; render(); });
            } else if (activeTab === 'debts') {
                document.getElementById('debt-form')?.addEventListener('submit', handleDebtFormSubmit);
                document.querySelectorAll('.edit-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtClick(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debt')?.addEventListener('click', () => { document.getElementById('debt-form').reset(); document.getElementById('debt-id').value = ''; document.getElementById('debt-form-title').textContent = 'üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà'; document.getElementById('cancel-edit-debt').classList.add('hidden'); document.getElementById('debt-evidence-name').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'; });
                document.getElementById('debts-search-input')?.addEventListener('input', e => { state.debtsSearchQuery = e.target.value; render(); });
                document.getElementById('debt-evidence-file')?.addEventListener('change', e => document.getElementById('debt-evidence-name').textContent = e.target.files[0]?.name || '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');
            } else if (activeTab === 'payments') {
                document.getElementById('payment-form')?.addEventListener('submit', handlePaymentFormSubmit);
                document.getElementById('payment-debtor-id')?.addEventListener('change', (e) => updateDebtsForPaymentForm(e.target.value));
                document.getElementById('payment-evidence-file')?.addEventListener('change', e => document.getElementById('payment-evidence-name').textContent = e.target.files[0]?.name || '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');
            } else if (activeTab === 'settings') {
                document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
                document.getElementById('save-to-sheets-manual')?.addEventListener('click', () => saveDataToSheets(true));
            }
        };

        const init = async () => {
            const savedState = localStorage.getItem('debtManagerData_backup');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.settings = parsed.settings || state.settings;
            }
            showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            if (state.settings.googleSheetUrl) {
                await loadFromGoogleSheets();
            } else {
                loadLocalBackup();
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', 'info');
            }
            hideLoadingOverlay();
            render();
            checkNotifications();
            setInterval(checkNotifications, 5 * 60 * 1000);
        };

        init();
    });
    </script>

</body>
</html>

