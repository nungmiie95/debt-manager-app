<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.14.1 (Critical Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .gradient-bg {
            background-image: linear-gradient(to right, #667eea, #764ba2);
        }
        .tab-active {
            border-bottom: 3px solid #fff;
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .tab-inactive {
            color: #e0e0e0;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .notification-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .notification-panel.open {
            transform: translateX(0);
        }
        .form-input {
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.4);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #667eea, #764ba2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
             background-image: none;
             background-color: #a0aec0;
             cursor: not-allowed;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #667eea;
        }
        .file-input-label {
            cursor: pointer;
            border: 2px dashed #cbd5e0;
        }
        .file-input-label:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        /* Sync Status Pill */
        .sync-status-pill {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .sync-status-pill.pending { background-color: #fef3c7; color: #92400e; } /* yellow */
        .sync-status-pill.syncing { background-color: #dbeafe; color: #1e40af; } /* blue */
        .sync-status-pill.success { background-color: #d1fae5; color: #065f46; } /* green */
        .sync-status-pill.error { background-color: #fee2e2; color: #991b1b; }   /* red */

        /* PIN Lock Screen Styles */
        #pin-screen {
            background-color: #f0f2f5;
        }
        .pin-dot {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #e2e8f0;
            border: 1px solid #cbd5e0;
        }
        .pin-dot.filled {
            background-color: #764ba2;
            border-color: #667eea;
        }
        .pin-key {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        .pin-key:active {
            background-color: #f7fafc;
        }
        .animate-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

    </style>
</head>
<body class="antialiased text-gray-800">
    
    <!-- PIN Lock Screen -->
    <div id="pin-screen" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="w-full max-w-xs text-center p-6">
            <h2 id="pin-title" class="text-2xl font-bold mb-2 text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å</h2>
            <p id="pin-message" class="text-gray-600 mb-6">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <div class="flex justify-center space-x-4 mb-6">
                <div class="pin-dot" id="dot-1"></div>
                <div class="pin-dot" id="dot-2"></div>
                <div class="pin-dot" id="dot-3"></div>
                <div class="pin-dot" id="dot-4"></div>
            </div>
            <div id="keypad" class="grid grid-cols-3 gap-4">
                <!-- Keypad will be generated here -->
            </div>
        </div>
    </div>


    <!-- Main Container (hidden initially) -->
    <div id="app" class="min-h-screen flex-col hidden">

        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-xl md:text-2xl font-bold">üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ V.14.1</h1>
                    <div id="global-sync-status" class="ml-3"></div>
                </div>
                <div class="relative">
                    <button id="notification-bell" class="relative focus:outline-none">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
            <!-- Tabs Navigation -->
            <nav id="tabs-container" class="bg-white/10">
                <div class="container mx-auto px-4 flex space-x-2 overflow-x-auto">
                    <button data-tab="dashboard" class="py-3 px-4 font-semibold whitespace-nowrap tab-active">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    <button data-tab="debtors" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="debts" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="payments" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</button>
                    <button data-tab="statement" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">üìà ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                    <button data-tab="settings" class="py-3 px-4 font-semibold whitespace-nowrap tab-inactive">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 md:p-6">
            <div id="tab-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </main>

    </div>

    <!-- Modals & Overlays -->
    <div id="modal-container"></div>
    <div id="alert-container" class="fixed top-20 right-5 z-50 space-y-2"></div>
    <div id="notification-panel-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- PIN LOCK LOGIC ---
        const PIN_KEY = 'debtManagerPinHash';
        let pinInput = '';
        let pinMode = 'enter'; // 'set', 'enter', 'confirm'
        let tempPin = '';

        const pinScreen = document.getElementById('pin-screen');
        const mainApp = document.getElementById('app');
        const pinTitle = document.getElementById('pin-title');
        const pinMessage = document.getElementById('pin-message');
        
        async function hashPin(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function updatePinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i <= pinInput.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        async function handlePinInput(key) {
            if (key === 'del') {
                pinInput = pinInput.slice(0, -1);
            } else if (pinInput.length < 4) {
                pinInput += key;
            }
            updatePinDots();

            if (pinInput.length === 4) {
                if (pinMode === 'set') {
                    tempPin = pinInput;
                    pinMode = 'confirm';
                    pinTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ PIN ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    pinMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                    pinInput = '';
                    setTimeout(updatePinDots, 100);
                } else if (pinMode === 'confirm') {
                    if (pinInput === tempPin) {
                        const hashedPin = await hashPin(pinInput);
                        localStorage.setItem(PIN_KEY, hashedPin);
                        unlockApp();
                    } else {
                        pinMessage.textContent = '‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                        pinMessage.classList.add('text-red-500');
                        pinScreen.classList.add('animate-shake');
                        setTimeout(() => {
                           pinMode = 'set';
                           tempPin = '';
                           pinTitle.textContent = '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å';
                           pinInput = '';
                           updatePinDots();
                           pinMessage.classList.remove('text-red-500');
                           pinScreen.classList.remove('animate-shake');
                        }, 1000);
                    }
                } else if (pinMode === 'enter') {
                    const storedHash = localStorage.getItem(PIN_KEY);
                    const enteredHash = await hashPin(pinInput);
                    if (enteredHash === storedHash) {
                        unlockApp();
                    } else {
                        pinMessage.textContent = '‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
                        pinMessage.classList.add('text-red-500');
                        pinScreen.classList.add('animate-shake');
                        setTimeout(() => {
                            pinInput = '';
                            updatePinDots();
                            pinMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                            pinMessage.classList.remove('text-red-500');
                            pinScreen.classList.remove('animate-shake');
                        }, 1000);
                    }
                }
            }
        }

        function generateKeypad() {
            const keypadContainer = document.getElementById('keypad');
            const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '', '0', 'del'];
            keys.forEach(key => {
                const keyEl = document.createElement('button');
                keyEl.className = 'pin-key text-2xl font-semibold rounded-full w-20 h-20 flex items-center justify-center focus:outline-none';
                if (key === 'del') {
                    keyEl.innerHTML = `&larr;`;
                } else {
                    keyEl.textContent = key;
                }

                if (key) {
                    keyEl.addEventListener('click', () => handlePinInput(key));
                } else {
                    keyEl.style.visibility = 'hidden';
                }
                keypadContainer.appendChild(keyEl);
            });
        }
        
        function unlockApp() {
            pinScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            initializeApp();
        }

        function checkPinStatus() {
            if (localStorage.getItem(PIN_KEY)) {
                pinMode = 'enter';
                pinTitle.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN';
                pinMessage.textContent = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ';
            } else {
                pinMode = 'set';
                // Title and message are already set for this mode.
            }
            generateKeypad();
        }
        
        // --- End of PIN Logic ---
        
        // --- UTILITY FUNCTIONS ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatCurrency = (amount, sign = '') => {
            if (isNaN(amount)) amount = 0;
            const formatted = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(Math.abs(amount));
            return amount < 0 ? `-${formatted}` : `${sign}${formatted}`;
        }
        const formatDateToBuddhist = (dateString, options = {}) => {
            if (!dateString) return '';
            const { year = 'numeric', month = 'long', day = 'numeric' } = options;
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString('th-TH', {
                    year, month, day, calendar: 'buddhist'
                });
            } catch (e) {
                console.error("Invalid date for formatting:", dateString);
                return 'N/A';
            }
        };
        const getDaysDifference = (date1, date2) => {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
            return Math.round((d1 - d2) / (1000 * 60 * 60 * 24));
        };

        // --- UI UTILITIES ---
        const showLoadingOverlay = (message) => {
            let overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.remove();
            overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop text-white';
            overlay.innerHTML = `<div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto"></div><p class="mt-4">${message}</p></div>`;
            document.body.appendChild(overlay);
        };
        const hideLoadingOverlay = () => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.remove();
        };
        const showAlert = (message, type = 'success') => {
             const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
             const alertEl = document.createElement('div');
             alertEl.className = `p-4 text-white ${colors[type]} rounded-lg shadow-lg animate-fade-in-down`;
             alertEl.textContent = message;
             document.getElementById('alert-container').appendChild(alertEl);
             setTimeout(() => { alertEl.remove(); }, 4000);
        };
        const showConfirmationModal = (title, message, onConfirm) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
                    <h3 class="text-lg font-bold mb-2">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="modal-confirm" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    </div>
                </div>`;
            document.getElementById('modal-container').appendChild(modal);
            document.getElementById('modal-cancel').addEventListener('click', () => modal.remove());
            document.getElementById('modal-confirm').addEventListener('click', () => { onConfirm(); modal.remove(); });
        };


        // --- STATE MANAGEMENT ---
        let state = {
            debtors: [],
            debts: [],
            payments: [],
            notifications: [],
            settings: {
                notifications: { overdue: true, upcoming: true, daysInAdvance: 7 },
                googleSheetUrl: ''
            },
            activeTab: 'dashboard',
            statementSelectedDebtor: "", // Empty string for "All"
            syncStatus: 'idle', // idle, pending, syncing, success, error
            debtorsSearchQuery: '',
            debtsSearchQuery: ''
        };
        
        // --- CACHING ---
        let calculationCache = new Map();


        // --- DEBOUNCER for auto-saving ---
        let saveTimeout;
        const debounceSave = () => {
            clearTimeout(saveTimeout);
            updateSyncStatus('pending');
            calculationCache.clear(); // Clear cache on data change
            saveTimeout = setTimeout(() => {
                saveDataToSheets(false); // auto-save doesn't show success alert
            }, 2500);
        };
        
        // --- DATA HANDLING ---
        const saveData = () => {
            localStorage.setItem('debtManagerData_backup', JSON.stringify(state)); // Use localStorage ONLY as a backup
            if (state.settings.googleSheetUrl) {
                debounceSave();
            }
        };

        const loadLocalBackup = () => {
            const data = localStorage.getItem('debtManagerData_backup');
            if (data) {
                const parsed = JSON.parse(data);
                state.debtors = parsed.debtors || [];
                state.debts = parsed.debts || [];
                state.payments = parsed.payments || [];
                state.notifications = parsed.notifications || [];
            }
        };

        // --- CORE CALCULATION ENGINE ---
        const generateStatementDataForDebt = (debtId, upToDate) => {
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt) return null;

            const cacheKey = `${debtId}-${upToDate.toISOString()}`;
            if (calculationCache.has(cacheKey)) return calculationCache.get(cacheKey);

            const payments = state.payments.filter(p => p.debtId === debtId).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let runningPrincipal = Number(debt.amount);
            let totalInterestAccrued = 0;
            let totalPaid = 0;
            let lastDate = new Date(debt.date);

            const processPeriod = (periodEndDate) => {
                const monthsDiff = (periodEndDate.getFullYear() - lastDate.getFullYear()) * 12 + (periodEndDate.getMonth() - lastDate.getMonth());
                if (monthsDiff > 0) {
                    const interestRate = Number(debt.interestRate || 0) / 100;
                    const principalForInterestCalc = debt.interestType === 'compound' ? runningPrincipal : Number(debt.amount);
                    const interestForPeriod = principalForInterestCalc * interestRate * monthsDiff;
                    
                    totalInterestAccrued += interestForPeriod;
                    if (debt.interestType === 'compound') {
                        runningPrincipal += interestForPeriod;
                    }
                }
                lastDate = periodEndDate;
            };

            payments.forEach(payment => {
                const paymentDate = new Date(payment.date);
                processPeriod(paymentDate);
                runningPrincipal -= Number(payment.amount);
                totalPaid += Number(payment.amount);
            });

            processPeriod(upToDate);
            
            const totalDebt = (debt.interestType === 'compound' ? runningPrincipal : Number(debt.amount)) + totalInterestAccrued;
            const balance = totalDebt - totalPaid;
            
            const result = { totalInterest: totalInterestAccrued, totalPaid, balance, totalDebt };
            calculationCache.set(cacheKey, result);
            return result;
        };


        const calculateDebtDetails = (debtId) => {
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt) return { totalInterest: 0, totalPaid: 0, balance: 0, isOverdue: false, daysOverdue: 0, isAnniversaryToday: false };
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const details = generateStatementDataForDebt(debtId, today);
            
            let isOverdue = false, daysOverdue = 0, isAnniversaryToday = false, anniversaryMonth = null;
            const startDate = new Date(debt.date);
            const interestRate = Number(debt.interestRate) || 0;

            if (debt.dueDate) {
                const dueDate = new Date(debt.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                if (dueDate < today && details.balance > 0) {
                    isOverdue = true;
                    daysOverdue = getDaysDifference(today, dueDate);
                }
            } else {
                if (interestRate > 0 && today.getDate() === startDate.getDate() && (today.getTime() !== startDate.getTime())) {
                    isAnniversaryToday = true;
                    anniversaryMonth = `${today.getFullYear()}-${today.getMonth()}`;
                }
            }
            
            return { ...details, isOverdue, daysOverdue, isAnniversaryToday, anniversaryMonth };
        };


        const getDebtorSummary = (debtorId) => ({
            totalBalance: state.debts
                .filter(d => d.debtorId === debtorId)
                .reduce((sum, debt) => sum + calculateDebtDetails(debt.id).balance, 0)
        });

        // --- UI RENDERING ---
        const render = () => {
            if (!state.settings.googleSheetUrl && state.activeTab !== 'settings') {
                state.activeTab = 'settings';
            }
            const tab = state.activeTab;
            const contentEl = document.getElementById('tab-content');
            
            document.querySelectorAll('#tabs-container button').forEach(button => {
                button.classList.toggle('tab-active', button.dataset.tab === tab);
                button.classList.toggle('tab-inactive', button.dataset.tab !== tab);
                if (!state.settings.googleSheetUrl && !['settings'].includes(button.dataset.tab)) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
            
            const renderMap = {
                dashboard: renderDashboard,
                debtors: renderDebtors,
                debts: renderDebts,
                payments: renderPayments,
                statement: renderStatement,
                settings: renderSettings
            };
            
            contentEl.innerHTML = renderMap[tab] ? renderMap[tab]() : `<p>Error</p>`;
            attachEventListeners();
            updateNotificationBell();
            updateSyncStatus(state.syncStatus);
        };
        
        const renderDashboard = () => {
            let totalPrincipal = state.debts.reduce((sum, d) => sum + (Number(d.amount) || 0), 0);
            let totalPaid = 0;
            let totalInterest = 0;
            let overdueDebtsCount = 0;
            let allUpcomingDebts = [];
            let totalBalance = 0;

            state.debts.forEach(debt => {
                const details = calculateDebtDetails(debt.id);
                totalInterest += details.totalInterest;
                totalPaid += details.totalPaid;
                totalBalance += details.balance;
                if (details.isOverdue) overdueDebtsCount++;

                if (details.balance <= 0) return;

                if (debt.dueDate) {
                    const daysUntilDue = getDaysDifference(debt.dueDate, new Date());
                    if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                        allUpcomingDebts.push({ ...debt, daysUntilDue, balance: details.balance, isMonthly: false, displayDate: debt.dueDate });
                    }
                } 
                else if (debt.interestRate > 0) {
                    const today = new Date();
                    const startDate = new Date(debt.date);
                    let nextAnniversary = new Date(today.getFullYear(), today.getMonth(), startDate.getDate());
                    if (nextAnniversary < today) nextAnniversary.setMonth(nextAnniversary.getMonth() + 1);
                    const daysUntilDue = getDaysDifference(nextAnniversary, today);
                    if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                        allUpcomingDebts.push({ ...debt, daysUntilDue, balance: details.balance, isMonthly: true, displayDate: nextAnniversary.toISOString() });
                    }
                }
            });

            const totalDebtValue = totalPrincipal + totalInterest;
            const paymentProgress = totalDebtValue > 0 ? (totalPaid / totalDebtValue) * 100 : 0;
            const overdueAlert = overdueDebtsCount > 0 ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 animate-pulse"><p class="font-bold">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô!</p><p>‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${overdueDebtsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>` : '';
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3><p class="text-2xl font-bold">${state.debtors.length} ‡∏Ñ‡∏ô</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üí∞ ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô)</h3><p class="text-2xl font-bold">${formatCurrency(totalPrincipal)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°</h3><p class="text-2xl font-bold">${formatCurrency(totalInterest)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500 text-green-600">üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</h3><p class="text-2xl font-bold text-green-600">${formatCurrency(totalPaid)}</p></div>
                    <div class="card bg-white p-4 rounded-lg shadow"><h3 class="text-gray-500 text-red-600">‚ùó ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h3><p class="text-2xl font-bold text-red-600">${formatCurrency(totalBalance)}</p></div>
                </div>
                ${overdueAlert}
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</th><th class="px-4 py-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="px-4 py-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th></tr></thead>
                                <tbody>
                                    ${allUpcomingDebts.length > 0 ? allUpcomingDebts.sort((a,b) => a.daysUntilDue - b.daysUntilDue).map(debt => {
                                        const detailText = debt.isMonthly 
                                            ? '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">‡∏£‡∏≠‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span>' 
                                            : '<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>';
                                        return `
                                        <tr class="bg-white border-b">
                                            <td class="px-4 py-2 font-medium">${state.debtors.find(d => d.id === debt.debtorId)?.name || 'N/A'}</td>
                                            <td class="px-4 py-2">${formatCurrency(debt.balance)}</td>
                                            <td class="px-4 py-2">${detailText}</td>
                                            <td class="px-4 py-2 font-medium text-gray-700">${formatDateToBuddhist(debt.displayDate)}</td>
                                        </tr>
                                    `}).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-gray-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${formatCurrency(totalPaid)} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${formatCurrency(totalDebtValue)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 my-2"><div class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full" style="width: ${paymentProgress.toFixed(2)}%"></div></div>
                        <p class="text-right font-bold">${paymentProgress.toFixed(2)}%</p>
                    </div>
                </div>`;
        };
        
        const renderDebtors = () => {
            const filteredDebtors = state.debtors.filter(d => d.name.toLowerCase().includes(state.debtorsSearchQuery.toLowerCase()));
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4" id="debtor-form-title">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                        <form id="debtor-form" class="space-y-4">
                            <input type="hidden" id="debtor-id">
                            <div><label for="debtor-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•*</label><input type="text" id="debtor-name" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div>
                            <div><label for="debtor-phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="debtor-phone" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="debtor-email" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-id-card" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="debtor-id-card" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="debtor-address" class="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><textarea id="debtor-address" rows="3" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <div class="flex items-center space-x-2"><button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button type="button" id="cancel-edit-debtor" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (${filteredDebtors.length})</h3><input type="text" id="debtors-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ..." class="form-input rounded-md border-gray-300 shadow-sm w-1/2" value="${state.debtorsSearchQuery}"></div>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            ${filteredDebtors.length > 0 ? filteredDebtors.map(debtor => `<div class="border p-4 rounded-lg bg-gray-50"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg">${debtor.name}</h4><p class="text-sm text-gray-600">${debtor.phone || ''}</p><p class="text-sm text-gray-600">${debtor.email || ''}</p></div><div class="flex space-x-2"><button data-id="${debtor.id}" class="edit-debtor-btn p-2 text-gray-500 hover:text-blue-600">‚úèÔ∏è</button><button data-id="${debtor.id}" class="delete-debtor-btn p-2 text-gray-500 hover:text-red-600">üóëÔ∏è</button></div></div><div class="mt-2 pt-2 border-t"><p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="font-bold text-red-600">${formatCurrency(getDebtorSummary(debtor.id).totalBalance)}</span></p></div></div>`).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        const renderDebts = () => {
            const filteredDebts = state.debts.filter(debt => { const debtor = state.debtors.find(d => d.id === debt.debtorId); return debtor && debtor.name.toLowerCase().includes(state.debtsSearchQuery.toLowerCase()); });
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4" id="debt-form-title">üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                        <form id="debt-form" class="space-y-4">
                            <input type="hidden" id="debt-id">
                            <div><label for="debt-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label><select id="debt-debtor-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>${state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}</select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="debt-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)*</label><input type="number" id="debt-amount" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="debt-interest-rate" class="block text-sm font-medium text-gray-700">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label><input type="number" id="debt-interest-rate" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div></div>
                            <div><label for="debt-interest-type" class="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label><select id="debt-interest-type" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"><option value="simple">‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (‡∏õ‡∏Å‡∏ï‡∏¥)</option><option value="compound">‡∏ó‡∏ö‡∏ï‡πâ‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î)</option></select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="debt-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ*</label><input type="date" id="debt-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="debt-due-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label><input type="date" id="debt-due-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></div></div>
                            <div><label for="debt-type" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ</label><select id="debt-type" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                            <div><label for="debt-evidence-file" class="block text-sm font-medium text-gray-700">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/PDF)</label><label for="debt-evidence-file" class="file-input-label mt-1 flex justify-center px-6 pt-5 pb-6 rounded-md"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><p class="text-sm text-gray-600" id="debt-evidence-name">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p></div></label><input type="file" id="debt-evidence-file" class="hidden" accept="image/*,.pdf"></div>
                            <div><label for="debt-description" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="debt-description" rows="2" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <div class="flex items-center space-x-2"><button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button type="button" id="cancel-edit-debt" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${filteredDebts.length})</h3><input type="text" id="debts-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ..." class="form-input rounded-md border-gray-300 shadow-sm w-1/2" value="${state.debtsSearchQuery}"></div>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            ${filteredDebts.length > 0 ? filteredDebts.map(debt => { 
                                const details = calculateDebtDetails(debt.id); 
                                const debtor = state.debtors.find(d => d.id === debt.debtorId); 
                                const overdueBadge = details.isOverdue ? `<span class="bg-red-100 text-red-800 text-xs font-bold mr-2 px-2.5 py-0.5 rounded-full">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${details.daysOverdue} ‡∏ß‡∏±‡∏ô</span>` : ''; 
                                const interestText = (debt.interestRate && debt.interestRate > 0) ? `| ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (${debt.interestRate}%/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ${debt.interestType === 'compound' ? '‡∏ó‡∏ö‡∏ï‡πâ‡∏ô' : '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô'})` : '| ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢';
                                return `
                                    <div class="border p-4 rounded-lg ${details.isOverdue ? 'bg-red-50' : 'bg-gray-50'}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-bold text-lg">${debtor?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠'} ${overdueBadge}</h4>
                                                <p class="text-sm text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô: ${formatCurrency(debt.amount)} ${interestText}</p>
                                                <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ: ${formatDateToBuddhist(debt.date)} | ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${debt.dueDate ? formatDateToBuddhist(debt.dueDate) : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î'}</p>
                                            </div>
                                            <div class="flex space-x-2">
                                                ${debt.evidence ? `<button data-id="${debt.id}" data-type="debt" class="view-evidence-btn p-2 text-gray-500 hover:text-blue-600">üìé</button>` : ''}
                                                <button data-id="${debt.id}" class="edit-debt-btn p-2 text-gray-500 hover:text-blue-600">‚úèÔ∏è</button>
                                                <button data-id="${debt.id}" class="delete-debt-btn p-2 text-gray-500 hover:text-red-600">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t grid grid-cols-3 gap-2 text-sm text-center">
                                            <div><span class="block text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="font-semibold">${formatCurrency(details.totalDebt)}</span></div>
                                            <div><span class="block text-gray-500 text-green-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span><span class="font-semibold text-green-600">${formatCurrency(details.totalPaid)}</span></div>
                                            <div><span class="block text-gray-500 text-red-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span><span class="font-semibold text-red-600">${formatCurrency(details.balance)}</span></div>
                                        </div>
                                    </div>`; 
                            }).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        const renderPayments = () => {
             const debtorOptions = state.debtors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
             return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4" id="payment-form-title">üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                        <form id="payment-form" class="space-y-4">
                            <input type="hidden" id="payment-id">
                            <div><label for="payment-debtor-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ*</label><select id="payment-debtor-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ --</option>${debtorOptions}</select></div>
                            <div><label for="payment-debt-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ*</label><select id="payment-debt-id" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required disabled><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô --</option></select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="payment-amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô*</label><input type="number" id="payment-amount" min="0" step="0.01" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div><div><label for="payment-date" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞*</label><input type="date" id="payment-date" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" required></div></div>
                            <div><label for="payment-method" class="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label><select id="payment-method" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"><option>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option><option>‡πÄ‡∏ä‡πá‡∏Ñ</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                             <div><label for="payment-evidence-file" class="block text-sm font-medium text-gray-700">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡∏™‡∏•‡∏¥‡∏õ)</label><label for="payment-evidence-file" class="file-input-label mt-1 flex justify-center px-6 pt-5 pb-6 rounded-md"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><p class="text-sm text-gray-600" id="payment-evidence-name">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p></div></label><input type="file" id="payment-evidence-file" class="hidden" accept="image/*,.pdf"></div>
                            <div><label for="payment-note" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="payment-note" rows="2" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm"></textarea></div>
                            <div class="flex items-center space-x-2">
                                <button type="submit" id="payment-submit-btn" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
                                <button type="button" id="cancel-edit-payment" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-white p-6 rounded-lg shadow">
                         <h3 class="text-lg font-semibold mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                         <div class="relative pl-4 border-l-2 border-gray-200 max-h-[60vh] overflow-y-auto pr-2">
                             ${state.payments.length > 0 ? [...state.payments].reverse().map(p => { 
                                 const debtor = state.debtors.find(d => d.id === p.debtorId); 
                                 return `
                                    <div class="mb-6 relative timeline-item">
                                        <div class="font-semibold">${debtor?.name || 'N/A'}</div>
                                        <time class="text-sm font-normal leading-none text-gray-400">${formatDateToBuddhist(p.date)}</time>
                                        <p class="text-base font-normal text-gray-600">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="font-bold text-green-600">${formatCurrency(p.amount)}</span> ‡∏ú‡πà‡∏≤‡∏ô ${p.method}.</p>
                                        ${p.note ? `<p class="text-sm text-gray-500 bg-gray-100 p-2 rounded-md mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${p.note}</p>` : ''}
                                        <div class="mt-2 flex items-center space-x-2">
                                            ${p.evidence ? `<button data-id="${p.id}" data-type="payment" class="view-evidence-btn text-sm text-blue-600 hover:underline">üìé ‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>` : ''}
                                            <button data-id="${p.id}" class="edit-payment-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button data-id="${p.id}" class="delete-payment-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">üóëÔ∏è ‡∏•‡∏ö</button>
                                        </div>
                                    </div>` 
                                }).join('') : '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>'}
                         </div>
                    </div>
                </div>
             `;
        };
        const renderStatement = () => {
            const debtorOptions = state.debtors.map(d => `<option value="${d.id}" ${state.statementSelectedDebtor === d.id ? 'selected' : ''}>${d.name}</option>`).join('');
            const statementTable = state.statementSelectedDebtor ? generateDebtorStatementTable(state.statementSelectedDebtor) : generateGlobalStatementTable();

            return `
                <div class="card bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 border-b pb-4">
                        <h3 class="text-xl font-semibold">üìà ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
                        <div class="mt-4 md:mt-0">
                            <label for="statement-debtor-select" class="mr-2 font-medium">‡πÅ‡∏™‡∏î‡∏á:</label>
                            <select id="statement-debtor-select" class="form-input rounded-md border-gray-300 shadow-sm">
                                <option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                                ${debtorOptions}
                            </select>
                        </div>
                    </div>
                    <div id="statement-table-container" class="overflow-x-auto">
                        ${statementTable}
                    </div>
                </div>
            `;
        };

        const generateGlobalStatementTable = () => {
            const allDebtsAsTx = state.debts.map(d => ({ ...d, type: 'debt', txDate: d.date }));
            const allPaymentsAsTx = state.payments.map(p => ({ ...p, type: 'payment', txDate: p.date }));
            let transactions = [...allDebtsAsTx, ...allPaymentsAsTx];
            transactions.sort((a, b) => new Date(a.txDate) - new Date(b.txDate));

            let runningBalance = 0;
            let totalIncome = 0;
            let totalExpense = 0;

            const tableRowsHtml = transactions.map(tx => {
                const debtor = state.debtors.find(d => d.id === tx.debtorId);
                const debtorName = debtor ? debtor.name : 'N/A';
                let incomeHtml = '<span class="text-gray-400">-</span>';
                let expenseHtml = '<span class="text-gray-400">-</span>';
                
                if (tx.type === 'debt') {
                    const expenseAmount = Number(tx.amount);
                    runningBalance -= expenseAmount;
                    totalExpense += expenseAmount;
                    expenseHtml = `<span class="text-red-600 font-medium">${formatCurrency(-expenseAmount)}</span>`;
                } else if (tx.type === 'payment') {
                    const incomeAmount = Number(tx.amount);
                    runningBalance += incomeAmount;
                    totalIncome += incomeAmount;
                    incomeHtml = `<span class="text-green-600 font-medium">${formatCurrency(incomeAmount, '+')}</span>`;
                }

                const description = tx.type === 'debt' ? `‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡πÅ‡∏Å‡πà ${debtorName}` : `‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å ${debtorName}`;
                const note = tx.note || tx.description || '-';

                return `
                    <tr class="border-b">
                        <td class="p-3">${formatDateToBuddhist(tx.txDate)}</td>
                        <td class="p-3">${description}</td>
                        <td class="p-3 text-right">${incomeHtml}</td>
                        <td class="p-3 text-right">${expenseHtml}</td>
                        <td class="p-3 text-right font-semibold">${formatCurrency(runningBalance)}</td>
                        <td class="p-3 text-xs text-gray-500">${note}</td>
                    </tr>
                `;
            }).join('');

            const netTotal = totalIncome - totalExpense;
            const netTotalClass = netTotal >= 0 ? 'text-green-600' : 'text-red-600';

            return `
                <h4 class="text-lg font-bold mb-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-3 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
                            <th class="p-3 text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
                            <th class="p-3 text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th class="p-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRowsHtml || `<tr><td colspan="6" class="text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`}
                    </tbody>
                    <tfoot class="bg-gray-200 font-bold">
                        <tr>
                            <td colspan="2" class="p-3 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</td>
                            <td class="p-3 text-right text-green-600">${formatCurrency(totalIncome)}</td>
                            <td class="p-3 text-right text-red-600">${formatCurrency(-totalExpense)}</td>
                            <td class="p-3 text-right ${netTotalClass}" colspan="2">${formatCurrency(netTotal)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
        };
        
        const generateDebtorStatementTable = (debtorId) => {
            const debtor = state.debtors.find(d => d.id === debtorId);
            if (!debtor) return '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>';

            const debtorDebts = state.debts.filter(d => d.debtorId === debtorId);
            const debtorPayments = state.payments.filter(p => p.debtorId === debtorId);
            
            let transactions = [
                ...debtorDebts.map(d => ({ ...d, type: 'debt', txDate: d.date })),
                ...debtorPayments.map(p => ({ ...p, type: 'payment', txDate: p.date }))
            ];
            transactions.sort((a, b) => new Date(a.txDate) - new Date(b.txDate));

            let runningBalance = 0;
            let interestPaidTracker = {};

            const tableRowsHtml = transactions.map(tx => {
                if (tx.type === 'debt') {
                    const principalAmount = Number(tx.amount);
                    runningBalance += principalAmount;
                    interestPaidTracker[tx.id] = 0;
                    return `
                        <tr class="border-b">
                            <td class="p-3">${formatDateToBuddhist(tx.txDate)}</td>
                            <td class="p-3">‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ - ${tx.type}</td>
                            <td class="p-3 text-blue-600 font-medium">${formatCurrency(principalAmount, '+')}</td>
                            <td class="p-3 text-center">-</td>
                            <td class="p-3 text-blue-600 font-semibold">${formatCurrency(principalAmount, '+')}</td>
                            <td class="p-3 font-semibold">${formatCurrency(runningBalance)}</td>
                            <td class="p-3 text-xs text-gray-500">${tx.description || '-'}</td>
                        </tr>`;
                } else if (tx.type === 'payment') {
                    const debt = state.debts.find(d => d.id === tx.debtId);
                    if (!debt) return '';

                    const interestAccruedTotal = calculateInterestUpTo(debt, new Date(tx.txDate));
                    const interestAlreadyPaid = interestPaidTracker[tx.debtId] || 0;
                    const interestDueForThisPayment = interestAccruedTotal - interestAlreadyPaid;

                    const paymentAmount = Number(tx.amount);
                    const paidToInterest = Math.min(paymentAmount, Math.max(0, interestDueForThisPayment));
                    const paidToPrincipal = paymentAmount - paidToInterest;

                    interestPaidTracker[tx.debtId] += paidToInterest;
                    runningBalance -= paymentAmount;
                    return `
                       <tr class="border-b bg-green-50">
                            <td class="p-3">${formatDateToBuddhist(tx.txDate)}</td>
                            <td class="p-3">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - ${tx.method}</td>
                            <td class="p-3 text-green-700">${paidToPrincipal > 0 ? formatCurrency(-paidToPrincipal) : '-'}</td>
                            <td class="p-3 text-red-600">${paidToInterest > 0 ? formatCurrency(-paidToInterest) : '-'}</td>
                            <td class="p-3 text-green-700 font-semibold">${formatCurrency(-paymentAmount)}</td>
                            <td class="p-3 font-semibold">${formatCurrency(runningBalance)}</td>
                            <td class="p-3 text-xs text-gray-500">${tx.note || '-'}</td>
                        </tr>`;
                }
                return '';
            }).join('');

            return `
                <h4 class="text-lg font-bold mb-2">Statement ‡∏Ç‡∏≠‡∏á: ${debtor.name}</h4>
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="p-3">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th>
                            <th class="p-3">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th>
                            <th class="p-3">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th class="p-3">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                            <th class="p-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRowsHtml || `<tr><td colspan="7" class="text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`}
                    </tbody>
                </table>`;
        };
        const renderSettings = () => {
             const welcomeMessage = !state.settings.googleSheetUrl ? `
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
                    <h4 class="font-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h4>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</p>
                </div>
            ` : '';
            return `
                <div class="max-w-4xl mx-auto">
                    ${welcomeMessage}
                    <div class="card bg-white p-6 rounded-lg shadow mb-6">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">üîÑ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheets</h3>
                        <p class="text-gray-600 mb-4">‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Google Sheets ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        <div>
                            <label for="google-sheet-url" class="block text-sm font-medium text-gray-700">Google Apps Script URL</label>
                            <input type="url" id="google-sheet-url" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" value="${state.settings.googleSheetUrl || ''}">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ URL, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏° <span class="font-bold">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></p>
                        <div class="mt-4 flex flex-col sm:flex-row gap-2">
                             <button id="save-settings-btn" class="flex-1 btn-primary text-white font-bold py-2 px-4 rounded-md">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                             <button id="save-to-sheets-manual" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">üì§ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>
                    
                    <div class="card bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between"><span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span><input type="checkbox" id="setting-overdue" class="form-checkbox h-5 w-5 text-purple-600" ${state.settings.notifications.overdue ? 'checked' : ''}/></label>
                            <label class="flex items-center justify-between"><span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span><input type="checkbox" id="setting-upcoming" class="form-checkbox h-5 w-5 text-purple-600" ${state.settings.notifications.upcoming ? 'checked' : ''}/></label>
                            <div>
                                <label for="setting-days" class="block text-sm font-medium text-gray-700">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô)</label>
                                <input type="number" id="setting-days" min="1" class="mt-1 block w-full form-input rounded-md border-gray-300 shadow-sm" value="${state.settings.notifications.daysInAdvance}">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderNotificationPanel = () => {
            const panel = document.getElementById('notification-panel-container');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            const notificationItems = state.notifications.length > 0 ? [...state.notifications].reverse().map(renderNotificationItem).join('') : '<p class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>';
            panel.innerHTML = `
                <div id="notification-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
                <div id="notification-panel" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-lg z-50 notification-panel">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-lg font-semibold">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (${unreadCount} ‡πÉ‡∏´‡∏°‡πà)</h3>
                        <button id="close-notification-panel" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="p-2 space-y-2 overflow-y-auto h-[calc(100%-120px)]">${notificationItems}</div>
                    <div class="absolute bottom-0 left-0 right-0 p-2 border-t bg-gray-50 grid grid-cols-2 gap-2">
                        <button id="mark-all-read-btn" class="text-sm bg-gray-200 py-2 px-4 rounded-md">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button id="delete-all-btn" class="text-sm bg-red-100 text-red-700 py-2 px-4 rounded-md">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>`;
        };

        const renderNotificationItem = (notification) => {
            const colors = { 
                overdue: 'border-red-500', 
                upcoming: 'border-yellow-500', 
                payment: 'border-green-500',
                interest_due: 'border-blue-500'
            };
            return `
                <div class="p-3 rounded-lg border-l-4 ${colors[notification.type] || 'border-gray-500'} ${notification.read ? 'bg-gray-100' : 'bg-blue-50'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${notification.title}</p>
                            <p class="text-sm text-gray-600">${notification.message}</p>
                        </div>
                        <div class="flex items-center space-x-1">
                            ${!notification.read ? `<button data-id="${notification.id}" class="mark-read-btn p-1 text-gray-400 hover:text-green-600" title="Mark as read">‚úì</button>` : ''}
                            <button data-id="${notification.id}" class="delete-notification-btn p-1 text-gray-400 hover:text-red-600" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
        };
        
        // --- GOOGLE SHEETS & DRIVE HANDLING ---
        const updateSyncStatus = (status) => {
            state.syncStatus = status;
            const statusEl = document.getElementById('global-sync-status');
            if (!statusEl) return;
            const statusMap = {
                idle:    { text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', class: 'success' },
                pending: { text: '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', class: 'pending' },
                syncing: { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', class: 'syncing' },
                success: { text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', class: 'success' },
                error:   { text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', class: 'error' },
            };
            const current = statusMap[status] || statusMap.idle;
            statusEl.innerHTML = `<span class="sync-status-pill ${current.class}">${current.text}</span>`;
        };

        const uploadFileToDrive = async (file) => {
            if (!state.settings.googleSheetUrl) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô');
            if (!file) return null;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const [meta, data] = e.target.result.split(',');
                        const [_, mimeType] = meta.match(/:(.*?);/);
                        const payload = { action: 'uploadFile', fileData: data, fileName: file.name, mimeType: mimeType };
                        const res = await fetch(state.settings.googleSheetUrl, { method: 'POST', body: JSON.stringify(payload) });
                        if (!res.ok) throw new Error(`Server error: ${res.statusText}`);
                        const result = await res.json();
                        if (result.status === 'success') resolve(result.fileUrl);
                        else throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå');
                    } catch (error) { reject(error); }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };
        
        const saveDataToSheets = async (showSuccessAlert = false) => {
            if (!state.settings.googleSheetUrl) {
                updateSyncStatus('error');
                if (showSuccessAlert) showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            clearTimeout(saveTimeout);
            updateSyncStatus('syncing');
            try {
                const payload = { action: 'syncData', data: { debtors: state.debtors, debts: state.debts, payments: state.payments } };
                const res = await fetch(state.settings.googleSheetUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                if (!res.ok) throw new Error(`Server returned status: ${res.status}`);
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
                updateSyncStatus('success');
                if (showSuccessAlert) showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error("Save to Sheets error:", error);
                updateSyncStatus('error');
                if (showSuccessAlert) showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`, 'error');
            }
        };

        const loadFromGoogleSheets = async () => {
            if (!state.settings.googleSheetUrl) return;
            updateSyncStatus('syncing');
            try {
                 const res = await fetch(`${state.settings.googleSheetUrl}?action=getData`);
                 if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                 const result = await res.json();
                 if (result.status !== 'success') throw new Error(result.message);
                 state.debtors = (result.data.debtors || []).map(d => ({...d, amount: Number(d.amount), interestRate: Number(d.interestRate)}));
                 state.debts = (result.data.debts || []).map(d => ({...d, amount: Number(d.amount), interestRate: Number(d.interestRate)}));
                 state.payments = (result.data.payments || []).map(p => ({...p, amount: Number(p.amount)}));
                 updateSyncStatus('success');
                 showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                 console.error("Load error:", error);
                 updateSyncStatus('error');
                 showAlert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ: ${error.message} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`, 'error');
                 loadLocalBackup();
            }
        };

        // --- EVENT HANDLERS & LOGIC ---
        const handleTabClick = (e) => { 
            if (e.target.dataset.tab) { 
                state.activeTab = e.target.dataset.tab; 
                render(); 
            } 
        };
        
        const handleDebtorFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#debtor-id').value;
            const debtorData = {
                id: id || generateId(), name: form.querySelector('#debtor-name').value.trim(), phone: form.querySelector('#debtor-phone').value.trim(), email: form.querySelector('#debtor-email').value.trim(),
                idCard: form.querySelector('#debtor-id-card').value.trim(), address: form.querySelector('#debtor-address').value.trim(),
                createdAt: id ? state.debtors.find(d => d.id === id).createdAt : new Date().toISOString()
            };
            if (!debtorData.name) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error'); return; }
            if (id) {
                const index = state.debtors.findIndex(d => d.id === id);
                if (index > -1) state.debtors[index] = debtorData;
                showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                state.debtors.push(debtorData);
                showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            saveData(); render();
        };

        const handleDebtFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#debt-id').value, submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                const fileInput = form.querySelector('#debt-evidence-file');
                let evidenceUrl = id ? state.debts.find(d => d.id === id).evidence : '';
                if (fileInput.files[0]) { submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...'; evidenceUrl = await uploadFileToDrive(fileInput.files[0]); }
                
                const debtData = {
                    id: id || generateId(), debtorId: form.querySelector('#debt-debtor-id').value, 
                    amount: parseFloat(form.querySelector('#debt-amount').value), 
                    interestRate: parseFloat(form.querySelector('#debt-interest-rate').value) || 0,
                    interestType: form.querySelector('#debt-interest-type').value,
                    date: form.querySelector('#debt-date').value, dueDate: form.querySelector('#debt-due-date').value, 
                    type: form.querySelector('#debt-type').value, description: form.querySelector('#debt-description').value.trim(), 
                    createdAt: id ? state.debts.find(d => d.id === id).createdAt : new Date().toISOString(), evidence: evidenceUrl
                };

                if (!debtData.debtorId || !debtData.amount || isNaN(debtData.amount) || !debtData.date) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                if (id) {
                    const index = state.debts.findIndex(d => d.id === id);
                    if (index > -1) state.debts[index] = debtData;
                    showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    state.debts.push(debtData);
                    showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                checkNotifications(); saveData(); render();
            } catch (error) { showAlert(error.message, 'error'); }
            finally { submitBtn.disabled = false; submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; }
        };
        
        const handlePaymentFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#payment-id').value, submitBtn = form.querySelector('#payment-submit-btn');
            submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            try {
                const fileInput = form.querySelector('#payment-evidence-file');
                let evidenceUrl = id ? state.payments.find(p => p.id === id)?.evidence : '';
                if (fileInput.files[0]) { 
                    submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...'; 
                    evidenceUrl = await uploadFileToDrive(fileInput.files[0]); 
                }
                
                const paymentData = {
                    id: id || generateId(), 
                    debtorId: form.querySelector('#payment-debtor-id').value, 
                    debtId: form.querySelector('#payment-debt-id').value, 
                    amount: parseFloat(form.querySelector('#payment-amount').value),
                    date: form.querySelector('#payment-date').value, 
                    method: form.querySelector('#payment-method').value, 
                    note: form.querySelector('#payment-note').value.trim(), 
                    createdAt: id ? state.payments.find(p => p.id === id).createdAt : new Date().toISOString(), 
                    evidence: evidenceUrl
                };

                if (!paymentData.debtorId || !paymentData.debtId || !paymentData.amount || !paymentData.date) { throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); }

                if (id) {
                    const index = state.payments.findIndex(p => p.id === id);
                    if (index > -1) state.payments[index] = paymentData;
                    showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    state.payments.push(paymentData);
                    createNotification({ type: 'payment', title: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ', message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${state.debtors.find(d=>d.id===paymentData.debtorId)?.name} ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ${formatCurrency(paymentData.amount)}` });
                    showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                saveData(); 
                render();
            } catch (error) { 
                showAlert(error.message, 'error'); 
            }
            finally { 
                submitBtn.disabled = false;
                // The text will be reset by render()
            }
        };

        const handleSaveSettings = () => {
            state.settings.notifications.overdue = document.getElementById('setting-overdue').checked;
            state.settings.notifications.upcoming = document.getElementById('setting-upcoming').checked;
            state.settings.notifications.daysInAdvance = parseInt(document.getElementById('setting-days').value) || 7;
            const oldUrl = state.settings.googleSheetUrl;
            state.settings.googleSheetUrl = document.getElementById('google-sheet-url').value.trim();
            
            localStorage.setItem('debtManagerData_backup', JSON.stringify(state));
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');

            if (state.settings.googleSheetUrl && oldUrl !== state.settings.googleSheetUrl) {
                showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...', 'info');
                initializeApp();
            }
        };

        const handleEditDebtorClick = (id) => {
            const debtor = state.debtors.find(d => d.id === id);
            if (!debtor) return;
            document.getElementById('debtor-id').value = debtor.id;
            document.getElementById('debtor-name').value = debtor.name;
            document.getElementById('debtor-phone').value = debtor.phone || '';
            document.getElementById('debtor-email').value = debtor.email || '';
            document.getElementById('debtor-id-card').value = debtor.idCard || '';
            document.getElementById('debtor-address').value = debtor.address || '';
            document.getElementById('debtor-form-title').textContent = 'üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ';
            document.getElementById('cancel-edit-debtor').classList.remove('hidden');
            document.getElementById('debtor-form').scrollIntoView({ behavior: 'smooth' });
        };
        const handleEditDebtClick = (id) => {
            const debt = state.debts.find(d => d.id === id);
            if (!debt) return;
            document.getElementById('debt-id').value = debt.id;
            document.getElementById('debt-debtor-id').value = debt.debtorId;
            document.getElementById('debt-amount').value = debt.amount;
            document.getElementById('debt-interest-rate').value = debt.interestRate || '';
            document.getElementById('debt-interest-type').value = debt.interestType || 'simple';
            document.getElementById('debt-date').value = debt.date ? new Date(debt.date).toISOString().substring(0, 10) : '';
            document.getElementById('debt-due-date').value = debt.dueDate ? new Date(debt.dueDate).toISOString().substring(0, 10) : '';
            document.getElementById('debt-type').value = debt.type;
            document.getElementById('debt-description').value = debt.description || '';
            document.getElementById('debt-form-title').textContent = 'üí≥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ';
            document.getElementById('cancel-edit-debt').classList.remove('hidden');
            document.getElementById('debt-evidence-name').textContent = debt.evidence ? '‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°)' : '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            document.getElementById('debt-form').scrollIntoView({ behavior: 'smooth' });
        };
        const handleEditPaymentClick = (id) => {
            const payment = state.payments.find(p => p.id === id);
            if (!payment) return;

            const form = document.getElementById('payment-form');
            form.querySelector('#payment-id').value = payment.id;
            form.querySelector('#payment-debtor-id').value = payment.debtorId;
            
            updateDebtsForPaymentForm(payment.debtorId, payment.debtId);
            
            form.querySelector('#payment-amount').value = payment.amount;
            form.querySelector('#payment-date').value = payment.date ? new Date(payment.date).toISOString().substring(0, 10) : '';
            form.querySelector('#payment-method').value = payment.method;
            form.querySelector('#payment-note').value = payment.note || '';
            
            form.querySelector('#payment-evidence-name').textContent = payment.evidence ? '‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°)' : '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            
            document.getElementById('payment-form-title').textContent = 'üí∏ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ';
            document.getElementById('payment-submit-btn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('cancel-edit-payment').classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        };
        const handleDeleteDebtorClick = (id) => {
            showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢', () => {
                state.debtors = state.debtors.filter(d => d.id !== id);
                state.debts = state.debts.filter(d => d.debtorId !== id);
                state.payments = state.payments.filter(p => p.debtorId !== id);
                saveData(); render(); showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            });
        };
        const handleDeleteDebtClick = (id) => {
            showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏µ‡πâ?', () => {
                state.debts = state.debts.filter(d => d.id !== id);
                state.payments = state.payments.filter(p => p.debtId !== id);
                saveData(); render(); showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            });
        };
        const handleDeletePaymentClick = (id) => {
            showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏µ‡πâ?', () => {
                state.payments = state.payments.filter(p => p.id !== id);
                saveData(); 
                render(); 
                showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            });
        };
        const updateNotificationBell = () => {
            const badge = document.getElementById('notification-badge');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        };

        const attachNotificationPanelListeners = () => {
            document.getElementById('close-notification-panel')?.addEventListener('click', toggleNotificationPanel);
            document.getElementById('notification-backdrop')?.addEventListener('click', toggleNotificationPanel);
            document.getElementById('mark-all-read-btn')?.addEventListener('click', () => { 
                state.notifications.forEach(n => n.read = true); 
                saveData(); 
                updateNotificationBell();
                refreshNotificationPanel();
            });
            document.getElementById('delete-all-btn')?.addEventListener('click', () => { 
                state.notifications = []; 
                saveData(); 
                updateNotificationBell();
                toggleNotificationPanel();
            });
            document.querySelectorAll('.mark-read-btn').forEach(btn => btn.addEventListener('click', (e) => handleMarkNotificationRead(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-notification-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteNotification(e.currentTarget.dataset.id)));
        };

        const refreshNotificationPanel = () => {
            renderNotificationPanel();
            document.getElementById('notification-panel')?.classList.add('open');
            document.getElementById('notification-backdrop')?.classList.remove('hidden');
            attachNotificationPanelListeners();
        };

        const toggleNotificationPanel = () => {
            let panel = document.getElementById('notification-panel');
            const isOpen = panel && panel.classList.contains('open');

            if (isOpen) {
                panel.classList.remove('open');
                document.getElementById('notification-backdrop').classList.add('hidden');
            } else {
                renderNotificationPanel();
                panel = document.getElementById('notification-panel');
                const backdrop = document.getElementById('notification-backdrop');
                
                setTimeout(() => {
                    panel.classList.add('open');
                    backdrop.classList.remove('hidden');
                }, 10);
                
                attachNotificationPanelListeners();
            }
        };
        const handleMarkNotificationRead = (id) => {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) notification.read = true;
            saveData();
            updateNotificationBell();
            refreshNotificationPanel();
        };
        const handleDeleteNotification = (id) => {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
            updateNotificationBell();
            refreshNotificationPanel();
        };
        const updateDebtsForPaymentForm = (debtorId, selectedDebtId = null) => {
            const debtSelectEl = document.getElementById('payment-debt-id');
            if (!debtSelectEl) return;
            if (!debtorId) {
                debtSelectEl.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô --</option>';
                debtSelectEl.disabled = true;
                return;
            }
            const relevantDebts = selectedDebtId 
                ? state.debts.filter(d => d.debtorId === debtorId) 
                : state.debts.filter(d => d.debtorId === debtorId && calculateDebtDetails(d.id).balance > 0);
            
            if (relevantDebts.length > 0) {
                debtSelectEl.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ --</option>';
                relevantDebts.forEach(debt => {
                    const balance = calculateDebtDetails(debt.id).balance;
                    const isSelected = debt.id === selectedDebtId ? 'selected' : '';
                    debtSelectEl.innerHTML += `<option value="${debt.id}" ${isSelected}>${debt.type} (‡∏Å‡∏π‡πâ ${formatDateToBuddhist(debt.date, { day: '2-digit', month: 'short', year: '2-digit' })}) - ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${formatCurrency(balance)}</option>`;
                });
                debtSelectEl.disabled = false;
                if(selectedDebtId) debtSelectEl.value = selectedDebtId;
            } else {
                debtSelectEl.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á --</option>';
                debtSelectEl.disabled = true;
            }
        };
        const createNotification = (data) => {
            const newNotification = { id: generateId(), read: false, createdAt: new Date().toISOString(), ...data };
            state.notifications.push(newNotification);
        };
        const checkNotifications = () => {
            const now = new Date();
            let hasNewNotifications = false;

            state.debts.forEach(debt => {
                const details = calculateDebtDetails(debt.id);
                const debtor = state.debtors.find(d => d.id === debt.debtorId);
                if (!debtor || details.balance <= 0) return;

                if (details.isOverdue && state.settings.notifications.overdue) {
                    const existing = state.notifications.find(n => n.debtId === debt.id && n.type === 'overdue');
                    if (!existing) {
                        createNotification({ debtId: debt.id, type: 'overdue', title: '‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î!', message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${debtor.name} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ ${details.daysOverdue} ‡∏ß‡∏±‡∏ô` });
                        hasNewNotifications = true;
                    }
                }

                if (debt.dueDate && state.settings.notifications.upcoming) {
                    const daysUntilDue = getDaysDifference(debt.dueDate, now);
                    if (daysUntilDue >= 0 && daysUntilDue <= state.settings.notifications.daysInAdvance) {
                        const existing = state.notifications.find(n => n.debtId === debt.id && n.type === 'upcoming');
                        if (!existing) {
                             createNotification({ debtId: debt.id, type: 'upcoming', title: '‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞', message: `‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${debtor.name} ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô ${daysUntilDue} ‡∏ß‡∏±‡∏ô` });
                             hasNewNotifications = true;
                        }
                    }
                }
                
                if (!debt.dueDate && details.isAnniversaryToday) {
                    const existing = state.notifications.find(n => n.debtId === debt.id && n.type === 'interest_due' && n.anniversaryMonth === details.anniversaryMonth);
                    if (!existing) {
                        createNotification({ 
                            debtId: debt.id, type: 'interest_due', title: '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', 
                            message: `‡∏´‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á ${debtor.name} ‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
                            anniversaryMonth: details.anniversaryMonth
                        });
                        hasNewNotifications = true;
                    }
                }
            });

            if (hasNewNotifications) {
                updateNotificationBell();
                saveData();
            }
        };
        
        const attachEventListeners = () => {
            document.getElementById('tabs-container').addEventListener('click', handleTabClick);
            document.getElementById('notification-bell')?.addEventListener('click', toggleNotificationPanel);
            document.querySelectorAll('.view-evidence-btn').forEach(btn => btn.addEventListener('click', e => { const { type, id } = e.currentTarget.dataset; const item = state[type === 'debt' ? 'debts' : 'payments'].find(i => i.id === id); if (item && item.evidence) window.open(item.evidence, '_blank'); }));
            const activeTab = state.activeTab;
            
            if (activeTab === 'debtors') {
                document.getElementById('debtor-form')?.addEventListener('submit', handleDebtorFormSubmit);
                document.querySelectorAll('.edit-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtorClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debtor-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtorClick(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debtor')?.addEventListener('click', () => { document.getElementById('debtor-form').reset(); document.getElementById('debtor-id').value = ''; document.getElementById('debtor-form-title').textContent = 'üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà'; document.getElementById('cancel-edit-debtor').classList.add('hidden'); });
                document.getElementById('debtors-search-input')?.addEventListener('input', e => { state.debtorsSearchQuery = e.target.value; render(); });
            } else if (activeTab === 'debts') {
                document.getElementById('debt-form')?.addEventListener('submit', handleDebtFormSubmit);
                document.querySelectorAll('.edit-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditDebtClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-debt-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteDebtClick(e.currentTarget.dataset.id)));
                document.getElementById('cancel-edit-debt')?.addEventListener('click', () => { document.getElementById('debt-form').reset(); document.getElementById('debt-id').value = ''; document.getElementById('debt-form-title').textContent = 'üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà'; document.getElementById('cancel-edit-debt').classList.add('hidden'); document.getElementById('debt-evidence-name').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'; });
                document.getElementById('debts-search-input')?.addEventListener('input', e => { state.debtsSearchQuery = e.target.value; render(); });
                document.getElementById('debt-evidence-file')?.addEventListener('change', e => document.getElementById('debt-evidence-name').textContent = e.target.files[0]?.name || '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');
            } else if (activeTab === 'payments') {
                document.getElementById('payment-form')?.addEventListener('submit', handlePaymentFormSubmit);
                document.querySelectorAll('.edit-payment-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditPaymentClick(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-payment-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeletePaymentClick(e.currentTarget.dataset.id)));
                document.getElementById('payment-debtor-id')?.addEventListener('change', (e) => updateDebtsForPaymentForm(e.target.value));
                document.getElementById('payment-evidence-file')?.addEventListener('change', e => document.getElementById('payment-evidence-name').textContent = e.target.files[0]?.name || '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');
                document.getElementById('cancel-edit-payment')?.addEventListener('click', () => { 
                    const form = document.getElementById('payment-form');
                    form.reset(); 
                    form.querySelector('#payment-id').value = '';
                    document.getElementById('payment-form-title').textContent = 'üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ';
                    document.getElementById('payment-submit-btn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞';
                    document.getElementById('cancel-edit-payment').classList.add('hidden');
                    updateDebtsForPaymentForm(null);
                });
            } else if (activeTab === 'statement') {
                 document.getElementById('statement-debtor-select')?.addEventListener('change', e => {
                    state.statementSelectedDebtor = e.target.value;
                    render();
                });
            } else if (activeTab === 'settings') {
                document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
                document.getElementById('save-to-sheets-manual')?.addEventListener('click', () => saveDataToSheets(true));
            }
        };

        const initializeApp = async () => {
            const savedState = localStorage.getItem('debtManagerData_backup');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.settings = parsed.settings || state.settings;
                state.statementSelectedDebtor = parsed.statementSelectedDebtor === undefined ? "" : parsed.statementSelectedDebtor;
            }

            if (state.settings.googleSheetUrl) {
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...');
                await loadFromGoogleSheets();
                hideLoadingOverlay();
                checkNotifications();
                setInterval(checkNotifications, 5 * 60 * 1000);
            } else {
                state.activeTab = 'settings';
                loadLocalBackup();
            }
            render();
        };

        // Initial check: This starts everything.
        checkPinStatus();
    });
    </script>

</body>
</html>

